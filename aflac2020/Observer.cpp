//
//  Observer.cpp
//  aflac2020
//
//  Copyright Â© 2019 Ahiruchan Koubou. All rights reserved.
//

#include "app.h"
#include "Observer.hpp"
#include "StateMachine.hpp"

//DataLogger angLLogger("angL",10);
//DataLogger angRLogger("angR",10);

// global variables to pass FIR-filtered color from Observer to Navigator and its sub-classes
rgb_raw_t g_rgb;
hsv_raw_t g_hsv;
int16_t g_grayScale, g_grayScaleBlueless;
// global variables to gyro sensor output from Observer to  Navigator and its sub-classes
int16_t g_angle, g_anglerVelocity;
int16_t g_challenge_stepNo, g_color_brightness;


Observer::Observer(Motor* lm, Motor* rm, Motor* am, Motor* tm, TouchSensor* ts, SonarSensor* ss, GyroSensor* gs, ColorSensor* cs) {
    _debug(syslog(LOG_NOTICE, "%08u, Observer constructor", clock->now()));
    leftMotor   = lm;
    rightMotor  = rm;
    armMotor = am;
    tailMotor = tm;
    touchSensor = ts;
    sonarSensor = ss;
    gyroSensor  = gs;
    colorSensor = cs;

    distance = azimuth = locX = locY = aveDiffAng = deltaDiff = prevDeltaDiff = 0.0;
    prevAngL = prevAngR = 0;
    integD = integDL = integDR = 0.0; // temp

    notifyDistance = 0;
    traceCnt = 0;
    diffAng = 0;
    sumDiffAng = 0;
    countAng = 0;
    prevGS = INT16_MAX;
    touch_flag = false;
    sonar_flag = false;
    backButton_flag = false;
    lost_flag = false;
    blue_flag = false;
    
    // For Challenge Run
    line_over_flg = false;
    move_back_flg = false;
    slalom_flg = false;
    curRgbSum = 0;
    prevRgbSum = 0;
    curAngle = 0;
    prevAngle = 0;
    curDegree180 = 0;
    prevDegree180 = 0;
    curDegree360 = 0;
    prevDegree360 = 0;
    accumuDegree = 0;
    g_challenge_stepNo = 0;
    curSonarDis = 0;
    prevSonarDis = 0;
    prevDis = 0;
    prevDisX = 0;
    prevDisY = 0;
    root_no = 0;
    turnDegree=0;
    tempDis = 0;
    line_on_stat=0;
    exception_stat=0;
    gyroSensor->setOffset(0);

    fir_r = new FIR_Transposed<FIR_ORDER>(hn);
    fir_g = new FIR_Transposed<FIR_ORDER>(hn);
    fir_b = new FIR_Transposed<FIR_ORDER>(hn);
    ma = new MovingAverage<int32_t, MA_CAP>();
}

void Observer::activate() {
    // register cyclic handler to EV3RT
    sta_cyc(CYC_OBS_TSK);
    //clock->sleep() seems to be still taking milisec parm
    clock->sleep(PERIOD_OBS_TSK/2/1000); // wait a while
    _debug(syslog(LOG_NOTICE, "%08u, Observer handler set", clock->now()));
}

void Observer::reset() {
    distance = azimuth = locX = locY = 0.0;
    prevAngL = leftMotor->getCount();
    prevAngR = rightMotor->getCount();
    integD = integDL = integDR = 0.0; // temp
}

void Observer::notifyOfDistance(int32_t delta) {
    notifyDistance = delta + distance;
}

int32_t Observer::getDistance() {
    return (int32_t)distance;
}

int16_t Observer::getAzimuth() {
    // degree = 360.0 * radian / M_2PI;
    int16_t degree = (360.0 * azimuth / M_2PI);
    return degree;
}

int16_t Observer::getDegree() {
    // degree = 360.0 * radian / M_2PI;
    int16_t degree = (360.0 * azimuth / M_2PI);
    if (degree > 180){
        degree -= 360;
    }
    return degree;
}

int32_t Observer::getLocX() {
    return (int32_t)locX;
}

int32_t Observer::getLocY() {
    return (int32_t)locY;
}

void Observer::operate() {
    colorSensor->getRawColor(cur_rgb);
    // process RGB by the Low Pass Filter
    cur_rgb.r = fir_r->Execute(cur_rgb.r);
    cur_rgb.g = fir_g->Execute(cur_rgb.g);
    cur_rgb.b = fir_b->Execute(cur_rgb.b);
    curRgbSum = cur_rgb.r + cur_rgb.g + cur_rgb.b;
    rgb_to_hsv(cur_rgb, cur_hsv);
    // save filtered color variables to the global area
    g_rgb = cur_rgb;
    g_hsv = cur_hsv;

    // calculate gray scale and save them to the global area
    if(slalom_flg){ //hinutest
        g_grayScale = (cur_rgb.r * 77 + cur_rgb.g * 150 + cur_rgb.b * 29) / 256;
        //g_grayScaleBlueless = (cur_rgb.r * 77 + cur_rgb.g * 150 + (cur_rgb.b - cur_rgb.g) * 29) / 256; // B - G cuts off blue
        g_grayScaleBlueless = (cur_rgb.r * 10 + cur_rgb.g * 217 + cur_rgb.b * 29) / 256;
        if (g_grayScaleBlueless < 30){
            g_grayScaleBlueless = 30;
        }else if (g_grayScaleBlueless < 40){
            g_grayScaleBlueless = 40;
        }else if (g_grayScaleBlueless > 54) {
            g_grayScaleBlueless = 55;
        }
    }else if(!garage_flg){
        g_grayScale = (cur_rgb.r * 77 + cur_rgb.g * 150 + cur_rgb.b * 29) / 256;
        g_grayScaleBlueless = (cur_rgb.r * 77 + cur_rgb.g * 150 + (cur_rgb.b - cur_rgb.g) * 29) / 256; // B - G cuts off blue
    }else{
        g_grayScale = (cur_rgb.r * 200 + cur_rgb.g * 10 + cur_rgb.b * 29) / 239;
        //g_grayScaleBlueless = (cur_rgb.r * 200 + cur_rgb.g * 10 + (cur_rgb.b - cur_rgb.g) * 29) / 239; // B - G cuts off blue
        //g_grayScaleBlueless = (cur_rgb.r * 77 + cur_rgb.g * 120 + (cur_rgb.b - cur_rgb.g) * 29) / 226; // B - G cuts off blue        g_color_brightness = colorSensor->getBrightness();
        g_grayScaleBlueless = (cur_rgb.r * 77 + cur_rgb.g * 140 + (cur_rgb.b - cur_rgb.g) * 29) / 246; // B - G cuts off blue        g_color_brightness = colorSensor->getBrightness();
    }

    // save gyro sensor output to the global area
    g_angle = gyroSensor->getAngle();
    g_anglerVelocity = gyroSensor->getAnglerVelocity();

    // accumulate distance
    int32_t curAngL = leftMotor->getCount();
    // angLLogger.logging(curAngL);
    int32_t curAngR = rightMotor->getCount();
    // angRLogger.logging(curAngR);
    double deltaDistL = M_PI * TIRE_DIAMETER * (curAngL - prevAngL) / 360.0;
    double deltaDistR = M_PI * TIRE_DIAMETER * (curAngR - prevAngR) / 360.0;
    double deltaDist = (deltaDistL + deltaDistR) / 2.0;
    distance += deltaDist;
    prevAngL = curAngL;
    prevAngR = curAngR;
    // calculate azimuth
    double deltaAzi = atan2((deltaDistL - deltaDistR), WHEEL_TREAD);
    azimuth += deltaAzi;
    if (azimuth > M_2PI) {
        azimuth -= M_2PI;
    } else if (azimuth < 0.0) {
        azimuth += M_2PI;
    }
    // estimate location
    locX += (deltaDist * sin(azimuth));
    locY += (deltaDist * cos(azimuth));

// modify start by Furuta 2020.09.23
    // monitor good timing to swith to BlindRunner
    if (countAng != -1) {
        if ((curAngL + curAngR) < AVERAGE_START) {
            // cutoff initial noize
            // syslog(LOG_NOTICE, "%08u, initial cutting off", clock->now());         
        } else if (((curAngL + curAngR) >= AVERAGE_START) && ((curAngL + curAngR) < AVERAGE_END)) {
            // calculate average of delta of angL and andR
            diffAng = curAngL - curAngR;
            sumDiffAng += diffAng;
            countAng ++;
            // syslog(LOG_NOTICE, "%08u, diffAng = %d, sum = %d, cnt = %d", clock->now(), diffAng, sumDiffAng, countAng);
        } else if (((curAngL + curAngR) >= AVERAGE_END)) {
            // judge whether should switch to BlindRunner
            aveDiffAng = (double)sumDiffAng / countAng;
            diffAng = curAngL - curAngR;
            prevDeltaDiff = deltaDiff;
            deltaDiff = diffAng - aveDiffAng;
            // syslog(LOG_NOTICE, "%08u, diffAng = %d, sum = %d, cnt = %d, ave = %f", clock->now(), diffAng, sumDiffAng, countAng, aveDiffAng);
           if (((deltaDiff < 0.0) && (prevDeltaDiff > 0.0)) ||
               ((deltaDiff > 0.0) && (prevDeltaDiff < 0.0))) {
                // Delta has been across Average
                syslog(LOG_NOTICE, "%08u, diffAng = %d, sum = %d, cnt = %d", clock->now(), diffAng, sumDiffAng, countAng);
                syslog(LOG_NOTICE, "%08u, Pass control to BlindRunner, prev = %d, delta = %d", clock->now(), (int)(prevDeltaDiff*1000), (int)(deltaDiff*1000));
                countAng = -1;  // event to be sent only once
                stateMachine->sendTrigger(EVT_robot_aligned);
            }
        }
    }

    // monitor distance
    if ((notifyDistance != 0.0) && (distance > notifyDistance)) {
         syslog(LOG_NOTICE, "%08u, distance reached", clock->now());
         notifyDistance = 0.0; // event to be sent only once
         stateMachine->sendTrigger(EVT_dist_reached);
    }
    
    // monitor touch sensor
    bool result = check_touch();
    if (result && !touch_flag) {
        syslog(LOG_NOTICE, "%08u, TouchSensor flipped on", clock->now());
        touch_flag = true;
        stateMachine->sendTrigger(EVT_touch_On);
    } else if (!result && touch_flag) {
        syslog(LOG_NOTICE, "%08u, TouchSensor flipped off", clock->now());
        touch_flag = false;
        stateMachine->sendTrigger(EVT_touch_Off);
    }
    
    // monitor sonar sensor
    result = check_sonar();
    if (result && !sonar_flag) {
        syslog(LOG_NOTICE, "%08u, SonarSensor flipped on", clock->now());
        sonar_flag = true;
        stateMachine->sendTrigger(EVT_sonar_On);
    } else if (!result && sonar_flag) {
        syslog(LOG_NOTICE, "%08u, SonarSensor flipped off", clock->now());
        sonar_flag = false;
        stateMachine->sendTrigger(EVT_sonar_Off);
    }
    
    // monitor Back Button
    result = check_backButton();
    if (result && !backButton_flag) {
        syslog(LOG_NOTICE, "%08u, Back button flipped on", clock->now());
        backButton_flag = true;
        stateMachine->sendTrigger(EVT_backButton_On);
    } else if (!result && backButton_flag) {
        syslog(LOG_NOTICE, "%08u, Back button flipped off", clock->now());
        backButton_flag = false;
        stateMachine->sendTrigger(EVT_backButton_Off);
    }

    if (!frozen) { // these checks are meaningless thus bypassed when frozen
        // determine if still tracing the line
        // result = check_lost();
        // if (result && !lost_flag) {
        //     syslog(LOG_NOTICE, "%08u, line lost", clock->now());
        //     lost_flag = true;
        //     stateMachine->sendTrigger(EVT_line_lost);
        // } else if (!result && lost_flag) {
        //     syslog(LOG_NOTICE, "%08u, line found", clock->now());
        //     lost_flag = false;
        //     stateMachine->sendTrigger(EVT_line_found);
        // }

        // temporary dirty logic to detect the second black to blue change
        int32_t ma_gs;
        if (prevGS == INT16_MAX) {
            prevTime = clock->now();
            prevGS = g_grayScale;
            ma_gs = ma->add(0);
        } else {
            curTime = clock->now();
            gsDiff = g_grayScale - prevGS;
            timeDiff = curTime - prevTime;
            ma_gs = ma->add(gsDiff * 1000000 / timeDiff);
            prevTime = curTime;
            prevGS = g_grayScale;
        }

        if ( (ma_gs > 150) || (ma_gs < -150) ){
            //syslog(LOG_NOTICE, "gs = %d, MA = %d, gsDiff = %d, timeDiff = %d", g_grayScale, ma_gs, gsDiff, timeDiff);
            if ( !blue_flag && ma_gs > 150 && g_rgb.b - g_rgb.r > 60 && g_rgb.b <= 255 && g_rgb.r <= 255 ) {
                blue_flag = true;
                syslog(LOG_NOTICE, "%08u, line color changed black to blue", clock->now());
                stateMachine->sendTrigger(EVT_bk2bl);
            } else if ( blue_flag && ma_gs < -150 && g_rgb.b - g_rgb.r < 40 ) {
                blue_flag = false;
                syslog(LOG_NOTICE, "%08u, line color changed blue to black", clock->now());
                stateMachine->sendTrigger(EVT_bl2bk);
            }
        }

        // determine if tilt
        // if ( check_tilt() ) {
        //     stateMachine->sendTrigger(EVT_tilt);
        // }
    }
    
    curDegree180 = getDegree() * _EDGE;
    curDegree360 = getAzimuth() * _EDGE;
    curSonarDis = sonarSensor->getDistance();

    //ã´ã¼ã«ããã¹ã©ã­ã¼ã ã«ç§»è¡ããåã®ã¨ã©ã¼å¦ç
     if(g_challenge_stepNo == 900 ){
         prevDis=distance;
         g_challenge_stepNo = 901;
     }else if(g_challenge_stepNo == 901){

        //ã©ã¤ã³ãã¬ã¼ã¹ãããç·ã«è½ã¡ãã½ãã¼ã
         if(cur_rgb.r <= 13 && cur_rgb.b <= 50 && cur_rgb.g > 60){
             printf("ç·æ¥ã¾ãã prevDis=%lf distance=%lf sa=%lf\n",prevDis,distance,distance-prevDis);
             //stateMachine->sendTrigger(EVT_green_on);
             if(own_abs(distance-prevDis)>130){
                 root_no=1;
             }else{
                 root_no=2;
             }
             g_challenge_stepNo = 902;
         }
     }else if(g_challenge_stepNo == 902){
        //é»ã¾ãã¯éãã¨ãããã
        //printf("g_challenge_stepNo = 903 r=%d,g=%d,b=%d,state=%d\n",cur_rgb.r,cur_rgb.g, cur_rgb.b,state);

        if((cur_rgb.g + cur_rgb.b <= 100 && cur_rgb.r <=50 && cur_rgb.g <=40 && cur_rgb.b <=60) || cur_rgb.b - cur_rgb.r >= 60 ){
            printf("é»æ¥ã¾ãã prevDis=%lf distance=%lf sa=%lf\n",prevDis,distance,distance-prevDis);
            //stateMachine->sendTrigger(EVT_line_on);
            g_challenge_stepNo = 903;
        }
    }else if(g_challenge_stepNo ==903){
        if(root_no == 2){
            clock->sleep(600);
        }else if(root_no==1){
            clock->sleep(700);
        }
        printf("state=%d\n",state);
        stateMachine->sendTrigger(EVT_black_found);
        prevDis=distance;
        g_challenge_stepNo = 904;
    }else if(g_challenge_stepNo == 904 && distance - prevDis > 80){
        stateMachine->sendTrigger(EVT_distance_over);
        g_challenge_stepNo = 905;
    }

        // Preparation for slalom climbing
        if(!slalom_flg && !garage_flg){
            if ((g_challenge_stepNo >= 900 && g_challenge_stepNo <= 905 ) && check_sonar(1,8) && !move_back_flg){
            //if (g_challenge_stepNo == 0 && check_sonar(1,8) && !move_back_flg){
                //state = ST_slalom; // cause of defect - removed on Oct.17g_challenge_stepNo
                g_challenge_stepNo = 0;
                printf("ã¹ã©ã­ã¼ã ã«è¿ã\n");
                armMotor->setPWM(-50);
                stateMachine->sendTrigger(EVT_slalom_reached);
                g_challenge_stepNo = 1;

                locX = 0;
                locY = 0; 
                distance = 0;
                prevAngL =0;
                prevAngR =0;
                leftMotor->reset();
                rightMotor->reset();
                azimuth = 0;
                prevDegree180 = getDegree();
                stateMachine->sendTrigger(EVT_slalom_reached);
                armMotor->setPWM(60);
                g_challenge_stepNo = 10;
                move_back_flg = true;
            }

            // Robot tilts whenn
            curAngle = g_angle;
            if(curAngle < -6){
                prevAngle = curAngle;
            }
            if (prevAngle < -6 && curAngle >= 0){
                printf("ã¹ã©ã­ã¼ã ãªã³\n");
                slalom_flg = true;
                curAngle = 0;
                prevAngle = 0;
                prevDis = distance;
                prevDisY = locY;
                //prevDegree180=getDegree();
                armMotor->setPWM(-100);
            }
        }

        // // æ«å®éä¸­ããå§ãããã
        // if(curSonarDis> 3 && curSonarDis < 20 && !slalom_flg && !garage_flg && g_challenge_stepNo==0 ){
        //     printf("ã»ãã»ã\n");
        //     stateMachine->sendTrigger(EVT_sonar_On);
        //     g_challenge_stepNo=900;
        // }

    if (_LEFT == 1){
         //ã¹ã©ã­ã¼ã å°ç¨å¦çï¼å·¦ã³ã¼ã¹ï¼
        if(slalom_flg && !garage_flg){
            //ã­ã°åºå
            // if ((g_challenge_stepNo >= 140 && g_challenge_stepNo <= 141)){
            //      if (++traceCnt && traceCnt > 1) {
            //          printf(",locX=%lf,prevDisX=%lf,locX - prevDisX=%lf,locY=%lf,locY - prevDisY=%lf,distance=%lf,prevDis=%lf,g_angle=%d,curDegree180=%d, curSonarDis=%d, g_challenge_stepNo=%d,r+g+b=%d\n",locX,prevDisX,locX - prevDisX,locY,locY - prevDisY,distance,prevDis,g_angle,curDegree180, curSonarDis,g_challenge_stepNo,curRgbSum);
            //          traceCnt = 0;
            //      }
            // }

            //åæä½ç½®ã®ç¹å®
            if(g_challenge_stepNo == 10 && distance - prevDis > 30){
                prevDisX = locX;
                prevRgbSum = curRgbSum;
                if(curRgbSum < 100){
                    //ãã¨ãã¨é»ã®ä¸ã«ããå ´åãã©ã¤ã³ä¸æ¹é¢ã«åè»¢
                    prevDisX = locX;
                    printf("ãã¨ãã¨é»ã®ä¸\n");
                    g_challenge_stepNo = 20;
                }else{
                    //å·¦ã«ã¼ã
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    g_challenge_stepNo = 11;
                }
            }else if(g_challenge_stepNo == 11){
                //ã»ã³ãµã¼ã§é»ãæ¤ç¥ããå ´å
                if(curRgbSum < 100 ){
                    //ãã®å ´ã§ã©ã¤ã³ä¸æ¹é¢ã«åè»¢
                    prevDisX = locX;
                    g_challenge_stepNo = 20;
                }
                //å·¦ã«ã¼ãã§é»ãè¦ã¤ããããªãã£ãå ´åããªãã¼ã¹ãåã®ä½ç½®ã¾ã§æ»ã
                else if(own_abs(prevDisX-locX) > 180 ){
                    if(prevRgbSum - curRgbSum > 20){
                        //é»ã«è¿ã¥ãã¦ããããããå°ãé å¼µã
                    }else{
                        //é»ã®çé±ãè¦ããªããã°éèµ°ãã
                        stateMachine->sendTrigger(EVT_slalom_challenge);
                        g_challenge_stepNo = 12;
                    }
                }
            //å·¦ã«ã¼ãããæ»ã
            }else if(g_challenge_stepNo == 12){
                if(prevDisX - locX <= 0){
                    //å³ã«ã¼ãã¸ç§»è¡
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    g_challenge_stepNo = 13;
                
                //éä¸­ã§é»ãæ¤ç¥ããå ´åãå·¦ä¸ã¸ç§»å
                }else if(curRgbSum < 100 ){
                    //ãã®å ´ã§ã©ã¤ã³ä¸æ¹é¢ã«åè»¢
                    prevDis = distance + 40; //hinuhinuhinu
                    g_challenge_stepNo = 13;
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    g_challenge_stepNo = 20;
                }

            }else if(g_challenge_stepNo == 13){
                //ã»ã³ãµã¼ã§é»ãæ¤ç¥ããå ´å
                if(curRgbSum < 100 ){
                    //ãã®å ´ã§ã©ã¤ã³ä¸æ¹é¢ã«åè»¢
                    prevDisX = locX;
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    g_challenge_stepNo = 20;
                }        

            }else if(g_challenge_stepNo == 20 && curDegree180 >= -30){
                //ãã®å ´ã§å·¦åè»¢
                g_challenge_stepNo = 21;
                stateMachine->sendTrigger(EVT_slalom_challenge);//21
                root_no = 1;
                printf("ä¸ããåè»¢ %d\n",curDegree180);

            }else if(g_challenge_stepNo == 20 && curDegree180 < -30){
                //ãã®å ´ã§å³åè»¢
                g_challenge_stepNo = 22;
                stateMachine->sendTrigger(EVT_slalom_challenge);//22
                root_no = 2;
                printf("ä¸ããåè»¢ã%d\n",curDegree180);

            }else if((g_challenge_stepNo == 21 && curDegree180 <= -30) || (g_challenge_stepNo == 22 && curDegree180 >= -31)){
                //è§åº¦ãä¸å®è§åº¦ã«ãªã£ãããåæ­¢ãç´é²
                printf("è§åº¦ã%d\n",curDegree180);
                g_challenge_stepNo = 23;
                stateMachine->sendTrigger(EVT_slalom_challenge); //23
                prevDis = distance;
                g_challenge_stepNo = 24;
            // ä¸ã«é²ã
            } else if(g_challenge_stepNo == 24){
                if((root_no == 1 && own_abs(distance - prevDis) > 210) || (root_no ==2 && own_abs(distance - prevDis) > 162)){
                    printf(",é»ã©ã¤ã³ä¸ååã«é²ã prevDis=%lf, distance=%lf\n", prevDis, distance);
                    stateMachine->sendTrigger(EVT_slalom_challenge); //24
                    g_challenge_stepNo = 30;
                }
            //é²è¡æ¹åã«å¯¾ãã¦æ¨ªè»¸ã«é²ãã ããè§åº¦ãæ»ã
            }else if(g_challenge_stepNo == 30){
    //           if((root_no == 1 && curDegree180 > prevDegree180 + 1 ) || (root_no == 2 && curDegree180 > prevDegree180 + 5)){
                if((root_no == 1 && curDegree180 > prevDegree180 + 6 ) || (root_no == 2 && curDegree180 > prevDegree180 + 10)){

                    printf(",é²è¡æ¹åã«å¯¾ãã¦æ¨ªè»¸ã«é²ãã ããè§åº¦ãæ»ãroot_no=%d prevDegree180=%d curDegree180=%d\n",root_no,prevDegree180,curDegree180);
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    g_challenge_stepNo = 40;
                    prevSonarDis = curSonarDis;
                    prevDis = distance;
                    prevDisX=locX;
                }
            }else if(g_challenge_stepNo ==40 && own_abs(distance - prevDis) > 30 ){
                //èª¿æ´ãã¹ã
                printf("ä¸åãã«ããåããç¢ºèª locX=%lf,prevDisX=%lf å·®å=%lf,prevDegree180=%d,curDegree180=%d\n",locX,prevDisX,locX-prevDisX,prevDegree180,curDegree180);
                g_challenge_stepNo = 31;
            }else if(g_challenge_stepNo == 999 && root_no ==2 && locX - prevDisX > 15 && locY - prevDisY < 400 && curSonarDis > prevSonarDis ){
                     printf(",æ¹åãä¸ã«èª¿æ´ãã \n");
                     g_challenge_stepNo = 32;
                     stateMachine->sendTrigger(EVT_slalom_challenge);
                     prevDegree180 = curDegree180;
              }else if(g_challenge_stepNo == 999 && root_no ==2 && ((locX - prevDisX >= 4.0 && curDegree180 - prevDegree180 < 5) || locX - prevDisX >= 6.0)){
// //            }else if(g_challenge_stepNo == 40 && (locX - prevDisX < -3 || check_sonar(255,255)) && locY - prevDisY < 450){
                     printf(",æ¹åãä¸ã«èª¿æ´ãã\n");
                     g_challenge_stepNo = 32;
                     stateMachine->sendTrigger(EVT_slalom_challenge);                    
                     prevDegree180 = curDegree180;
//     //        }else if((g_challenge_stepNo == 31 || g_challenge_stepNo == 32) && own_abs(prevDegree180 - curDegree180) >= 10 && check_sonar(0,20)){
//             }else if((g_challenge_stepNo == 31 || g_challenge_stepNo == 32) && ((own_abs(prevDegree180 - curDegree180) >= 15 && check_sonar(0,20)) || own_abs(prevDegree180 - curDegree180) >= 20)){
             }else if(g_challenge_stepNo == 32 &&  own_abs(prevDegree180 - curDegree180) >= 15){
                     printf(",èª¿æ´å®äº\n");
                     g_challenge_stepNo = 33;
                     stateMachine->sendTrigger(EVT_slalom_challenge);
                     g_challenge_stepNo = 34;
//             //  ï¼ã¤ç®ã®éå®³ç©ã«æ¥è¿ãããåããå¤ãã
            }else if ((g_challenge_stepNo == 34 || g_challenge_stepNo == 31) && (locY - prevDisY > 550 || check_sonar(0,5))){
                printf(",ï¼ã¤ç®ã®éå®³ç©ã«æ¥è¿ãããåããå¤ãã,g_challenge_stepNo=%d,locY = %lf,prevDisY = %lf ,curSonarDis=%d,locX=%lf,prevDisX=%lf\n",g_challenge_stepNo,locY,prevDisY,curSonarDis,locX,prevDisX);
                g_challenge_stepNo = 40;
                stateMachine->sendTrigger(EVT_slalom_challenge);
                g_challenge_stepNo = 50;
                prevRgbSum = curRgbSum;
                line_over_flg = false;
                prevRgbSum = curRgbSum;
            //  è¦çãæ´ãããå·¦ä¸ã«åé²ãã
            }else if(g_challenge_stepNo == 50  && (check_sonar(50,255)|| own_abs(curDegree180 - prevDegree180) > 70)){
                printf(",è¦çãæ´ããã¨ããã§åé²ãã ã½ãã¼=%d curDegree180=%d prevDegree180=%d",curSonarDis,curDegree180,prevDegree180);
                stateMachine->sendTrigger(EVT_slalom_challenge);
                g_challenge_stepNo = 60;
                prevRgbSum = curRgbSum;
                line_over_flg = false;
            //  é»ã©ã¤ã³ãè¶ããã¾ã§åé²ããè¶ãããåããèª¿æ´ãï¼ã¤ç®ã®éå®³ç©ã«æ¥è¿ãã
            }else if (g_challenge_stepNo == 60 && !line_over_flg){
                if (curRgbSum < 100) {
                    prevRgbSum = curRgbSum;
                }
                if(prevRgbSum < 100 && curRgbSum > 125){
                    printf(",é»ã©ã¤ã³ãè¶ãããåããèª¿æ´ãéå®³ç©ã«æ¥è¿ãã\n");
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    //prevDis=distance;
                    prevDisX = locX;
                    g_challenge_stepNo = 61;
                    prevDegree180 = curDegree180;
                    line_over_flg = true;
                    g_challenge_stepNo = 71;
                }else if(locY - prevDisY > 900){
                    //ï¼ãã³æåããé»ã©ã¤ã³ãè¶ããã«æ¨ªã«é²ãã å ´åã®ä¾å¤å¦ç
                    printf("ä¾å¤ééãé»ã©ã¤ã³ã®ç®æ");
                    g_challenge_stepNo = 61;
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    g_challenge_stepNo = 110;
                }
                
            }else if(g_challenge_stepNo == 71 && (locY - prevDisY > 710 || check_sonar(0,7))){
                    printf("ï¼ãã³æå locY=%lf, prevDisY=%lf,curSonarDis=%d\n",locY, prevDisY,curSonarDis);
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    g_challenge_stepNo = 80;
                    line_over_flg = true;
                    prevDegree180 = curDegree180;
            // è¦çãæ´ãããå·¦ä¸ã«åé²ãã
            }else if (g_challenge_stepNo == 80  && own_abs(prevDegree180 - curDegree180) > 61){
                    printf(",è¦çãæ´ãããå·¦ä¸ã«åé²ãã curDegree180=%d\n",curDegree180);
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    accumuDegree = own_abs(-33 - curDegree180); 
                    g_challenge_stepNo = 90;
                    prevRgbSum = curRgbSum;
                    line_over_flg = false;
            // é»ã©ã¤ã³ãè¶ããã¾ã§åé²ããè¶ãããåããèª¿æ´ãã
            }else if (g_challenge_stepNo == 90 && !line_over_flg){
                if (curRgbSum < 100) {
                    prevRgbSum = curRgbSum;
                    prevDis=distance;
                    tempDis = locX;
                }
                if(prevRgbSum < 100 && curRgbSum > 150 && own_abs(distance - prevDis) > 40){
                    printf(",é»ã©ã¤ã³ãè¶ãããåããèª¿æ´ããprevDisX=%lf  locX = %lf \n",prevDisX,locX);
                    stateMachine->sendTrigger(EVT_slalom_challenge); //90
                    prevDegree180 = curDegree180;
                    g_challenge_stepNo = 100;
                    line_over_flg = true;
                }

            //ï¼ãã³åé¿ä¸­ã«é»ã©ã¤ã³ã«è¡ã£ã¦ãã¾ããã¿ã¼ã³
            }else if( (g_challenge_stepNo == 80 && curRgbSum < 100) || (g_challenge_stepNo == 71 && curRgbSum < 100) ){
                    g_challenge_stepNo = 90;
                    clock->sleep(300);
                    printf(",ä¾å¤å¦çé»ã©ã¤ã³ãè¶ãããåããèª¿æ´ããprevDisX=%lf  locX = %lf \n",prevDisX,locX);
                    stateMachine->sendTrigger(EVT_slalom_challenge); //90
                    prevDegree180 = curDegree180;
                    g_challenge_stepNo = 100;
                    prevDisX=locX;
                    tempDis = locX;
                    line_over_flg = true;

            //  ï¼ã¤ç®ã®éå®³ç©ã«æ¥è¿ãã
            }else if(g_challenge_stepNo == 100 && own_abs(curDegree180 - prevDegree180) > 46 + accumuDegree ){ 
//            }else if(g_challenge_stepNo == 100 && (own_abs(curDegree180 - prevDegree180) > 52 + accumuDegree || curDegree180 > 5)){ 
                printf(",ï¼ã¤ç®ã®éå®³ç©ã«æ¥è¿ãããlocY=%lf,prevDisY=%lf,prevDegree180=%d ,curDegree180=%d,locX=%lf,prevDisX=%lf, curSonarDis=%d\n",locY,prevDisY,prevDegree180,curDegree180,locX,prevDisX,curSonarDis);
                stateMachine->sendTrigger(EVT_slalom_challenge);
                prevDisX=locX;
                prevDis=distance;
                prevDegree180 = curDegree180;
                g_challenge_stepNo = 101;
                line_over_flg = true;

            }else if(g_challenge_stepNo == 101 && own_abs(distance - prevDis) > 230 ){

                stateMachine->sendTrigger(EVT_slalom_challenge);
                prevDegree180 = curDegree180;
                g_challenge_stepNo = 112;
                printf("ï¼ï¼ï¼éãã¾ãã curRgbSum=%d.prevDegree180=%d, curDegree180=%d\n",curRgbSum,prevDegree180,curDegree180);

            }else if(g_challenge_stepNo == 112 && own_abs(curDegree180 - prevDegree180) > 50 ){
                stateMachine->sendTrigger(EVT_slalom_challenge);
                g_challenge_stepNo = 113;
                printf("ï¼ï¼ï¼éãã¾ãã curRgbSum=%d.prevDegree180=%d, curDegree180=%d\n",curRgbSum,prevDegree180,curDegree180);


            }else if (g_challenge_stepNo == 113 && distance - prevDis >= 150){
//            }else if ((g_challenge_stepNo == 113 || g_challenge_stepNo == 112 || g_challenge_stepNo == 111) && locY - prevDisY >= prevDis ){
                    g_challenge_stepNo = 131;
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    printf("ï¼ï¼ï¼éãã¾ãã curRgbSum=%d\n",curRgbSum);


             }else if (g_challenge_stepNo == 131 && curRgbSum <= 100){
                    g_challenge_stepNo = 1132;
                    printf("ï¼ï¼ï¼ï¼éãã¾ãã curRgbSum=%d\n",curRgbSum);

             }else if (g_challenge_stepNo == 1132 && curRgbSum > 130){
                    g_challenge_stepNo = 1133;
                    printf("ï¼ï¼ï¼éãã¾ãã curRgbSum=%d\n",curRgbSum);

            //}else if (g_challenge_stepNo == 1133 && curRgbSum <= 100){
             }else if ((g_challenge_stepNo == 1133 || (g_challenge_stepNo == 131 && !line_over_flg))&& curRgbSum <= 100){
                    g_challenge_stepNo = 133;
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    prevDegree180 = curDegree180;
                    g_challenge_stepNo = 140;
                     printf("ã¨ã¾ãã¾ããcurRgbSum=%d,è§åº¦=%d\n",curRgbSum,curDegree180);
             
             }else if((g_challenge_stepNo == 101 || g_challenge_stepNo == 112 || g_challenge_stepNo == 113||g_challenge_stepNo == 131||g_challenge_stepNo == 1132||g_challenge_stepNo == 1133) && curRgbSum<=100 ){
                    line_over_flg = false;

//            }else if(g_challenge_stepNo ==140 && (check_sonar(1,254))){
            //}else if(g_challenge_stepNo ==140){
             }else if(g_challenge_stepNo ==140 && (check_sonar(85,254) || own_abs(curDegree180 - prevDegree180) > 95)){
                printf(",ã½ãã¼ã«å¼ã£ããã£ã,g_challenge_stepNo=%d,ã½ãã¼=%d,è§åº¦=%d, curRgbSum=%d\n",g_challenge_stepNo,curSonarDis,own_abs(curDegree180 - prevDegree180),curRgbSum);
                //g_challenge_stepNo = 141; hinutest
                g_challenge_stepNo = 142;
                prevDegree180 = curDegree180;

            // // ç´é²ãã¹ã©ã­ã¼ã ãéãã hinutest
            // }else if(g_challenge_stepNo == 141 && own_abs(curDegree180 - prevDegree180) > 49){
            //     printf(",ç´é²ãã¹ã©ã­ã¼ã ãéãã,g_challenge_stepNo=%d,ã½ãã¼=%d,è§åº¦=%d, curRgbSum=%d\n",g_challenge_stepNo,curSonarDis,own_abs(curDegree180 - prevDegree180),curRgbSum);
            //     stateMachine->sendTrigger(EVT_slalom_challenge);
            //     prevDis=distance;
            //     armMotor->setPWM(30);
            //     g_challenge_stepNo = 150;
            // }


            // ã©ã¤ã³ãã¬ã¼ã¹ãã¿ã¼ã³hinutest
 //           }else if(g_challenge_stepNo == 142 && own_abs(curDegree180 - prevDegree180) > 49){ 
            }else if(g_challenge_stepNo == 142 && own_abs(curDegree180 - prevDegree180) > 51){
                printf(",ã©ã¤ã³ãã¬ã¼ã¹ã«ç§»ã,g_challenge_stepNo=%d,ã½ãã¼=%d,è§åº¦=%d, curRgbSum=%d\n",g_challenge_stepNo,curSonarDis,own_abs(curDegree180 - prevDegree180),curRgbSum);
                stateMachine->sendTrigger(EVT_line_on_pid_cntl);
                prevDis=distance;
                g_challenge_stepNo = 141;

            //}else if(g_challenge_stepNo == 141 && own_abs(distance - prevDis) > 250){
            }else if(g_challenge_stepNo == 141 && distance - prevDis > 150){
                printf(",ç´é²ãã¹ã©ã­ã¼ã ãéãã,g_challenge_stepNo=%d,ã½ãã¼=%d,è§åº¦=%d, curRgbSum=%d\n",g_challenge_stepNo,curSonarDis,own_abs(curDegree180 - prevDegree180),curRgbSum);
                stateMachine->sendTrigger(EVT_block_area_in);
                prevDis=distance;
                armMotor->setPWM(30);
                g_challenge_stepNo = 150;
            }


            // ã¹ã©ã­ã¼ã éãã¦ãã©ã°Off
            if(g_angle > 6 && g_challenge_stepNo <= 150 && g_challenge_stepNo >= 130){
                printf("ã¹ã©ã­ã¼ã ãªã\n");
                g_challenge_stepNo = 150;
                stateMachine->sendTrigger(EVT_slalom_challenge);
                state = ST_block;
                slalom_flg = false;
                garage_flg = true;
                locX = 0;
                locY = 0;
                distance = 0;
                prevAngL =0; 
                prevAngR =0; 
                azimuth = 0; 
                leftMotor->reset(); 
                rightMotor->reset(); 
                armMotor->setPWM(-100); 
                curAngle = 0;
                prevAngle = 0;
                root_no=0;
            }
        }

        //ãã¼ãã¹ãã­ãã¯ï¼ã¬ã¬ã¼ã¸å°ç¨å¦ç
        if (garage_flg && !slalom_flg && g_challenge_stepNo < 260 ){
            //  if (g_challenge_stepNo >= 150 && g_challenge_stepNo <= 170){
            // //     if (++traceCnt && traceCnt > 10) {
            //             printf(",garage_flg=%d,slalom_flg=%d,distance=%lf,g_angle=%d,curDegree180=%d,prevDegree180=%d. curSonarDis=%d, g_challenge_stepNo=%d,r=%d,g=%d,b=%d,locX=%lf,locY=%lf\n",garage_flg,slalom_flg,distance,g_angle,curDegree180,prevDegree180, curSonarDis,g_challenge_stepNo,cur_rgb.r,cur_rgb.g,cur_rgb.b,locX,locY);
            // //         traceCnt = 0;
            // //     }
            //}

            //ã¬ã¬ã¼ã¸ONå¾ãè·é¢ãä¸é¨æ®ãããã§ãããããè·é¢ããªã»ããããããã¨ãç¢ºèª
            if(g_challenge_stepNo == 150 && distance < 100 && distance > 1){
                g_challenge_stepNo = 151;
            }else if( g_challenge_stepNo == 151 && distance > 90){
                // ã½ãã¼ç¨¼ååè»¢ãæ¹åãèª¿æ´
                g_challenge_stepNo = 155;
                stateMachine->sendTrigger(EVT_block_challenge); //155
                clock->sleep(1000);
                printf("ã½ãã¼ç¨¼ååè»¢ãæ¹åãèª¿æ´ curSonarDis=%d,curDegree180=%d\n",curSonarDis,curDegree180);
                g_challenge_stepNo = 151;
                stateMachine->sendTrigger(EVT_block_challenge); //151
                g_challenge_stepNo = 152;
            }else if(g_challenge_stepNo == 152 && check_sonar(70,255)){
                printf("ã½ãã¼ã¬ã¬ã¼ã¸å¤ã curSonarDis=%d,curDegree180=%d\n",curSonarDis,curDegree180);
                prevDegree180 = curDegree180 + 20;
                stateMachine->sendTrigger(EVT_block_challenge); //152
                g_challenge_stepNo = 154;
                root_no=1;
            }else if (g_challenge_stepNo == 152 && check_sonar(1,70)){
                printf("ã½ãã¼ã¬ã¬ã¼ã¸å curSonarDis=%d,curDegree180=%d\n",curSonarDis,curDegree180);
                prevSonarDis = curSonarDis;
                prevDegree180 = curDegree180;
                stateMachine->sendTrigger(EVT_block_challenge); //152
                g_challenge_stepNo = 153;
                root_no=2;
            }else if (g_challenge_stepNo == 153 && check_sonar(80,255) ){
//            }else if (g_challenge_stepNo == 153 && (check_sonar(80,255) || own_abs(curDegree180 - prevDegree180) > 24)){
                printf("ã½ãã¼ã¬ã¬ã¼ã¸ããå¤ãã curSonarDis=%d,prevSonarDis=%d,curDegree180=%d,prevDegree180=%d\n",curSonarDis,prevSonarDis,curDegree180,prevDegree180);
                g_challenge_stepNo = 154;
                prevDegree180 = curDegree180;
            }else if (g_challenge_stepNo == 153){
                prevSonarDis = curSonarDis;
            //ä¸å®è§åº¦åè»¢
            }else if(g_challenge_stepNo == 154 && own_abs(curDegree180 - prevDegree180) > 50){
                //stateMachine->sendTrigger(EVT_block_challenge); //154
                g_challenge_stepNo = 170;
            //åç®ã©ã¤ã³æ¹åã¸é²è¡
            }else if(g_challenge_stepNo == 170 ){
                printf("åç®ã©ã¤ã³æ¹åã¸é²è¡ curSonarDis=%d,prevSonarDis=%d,curDegree180=%d,prevDegree180=%d\n",curSonarDis,prevSonarDis,curDegree180,prevDegree180);
                prevDis = distance;
                // åç®ã©ã¤ã³ã«æ¥è¿
                stateMachine->sendTrigger(EVT_block_challenge); //170
                g_challenge_stepNo = 171;
            
            //ç·ãè¦ã¤ããã //hinu
            }else if((g_challenge_stepNo == 171 || g_challenge_stepNo == 174) && cur_rgb.r <= 13 && cur_rgb.b <= 50 && cur_rgb.g > 60 ){
                clock->sleep(800);//ã¹ã©ã­ã¼ã å¾ãå¤§ããã©ã¤ã³ãå·¦ã«å¤ãã¦ããæåã®é»ã©ã¤ã³ã«å¼ã£ããããªãããã«ã¹ãªã¼ã
                printf("ç·ï¼éér=%d,g=%d,b=%d\n",cur_rgb.r,cur_rgb.g,cur_rgb.b);
                g_challenge_stepNo = 172;

            //é»oréãè¦ã¤ããã//hinu
            }else if(g_challenge_stepNo == 171 && (curRgbSum<=100 || cur_rgb.b - cur_rgb.r >=60)){
                printf("é»oréãçµç±ãå·¦å¯ãã«è½ã¡ã¾ãã distance-prevDis=%lf\n",own_abs(distance-prevDis));

                //ããããè¿½å ã³ã¼ã sano_t hinuhinuhinu
                if(distance-prevDis > 25 ){
                    g_challenge_stepNo = 173;
                    stateMachine->sendTrigger(EVT_block_challenge);
                    //clock->sleep(800);
                    printf("éã£ã\n");
                    g_challenge_stepNo = 170;
                    stateMachine->sendTrigger(EVT_block_challenge);
                }
                g_challenge_stepNo = 174;
                prevDis=distance;

                //ã¬ã¬ã¼ã¸å¤ãªãããã«æ²ãã
                // if(root_no==1){
                //     stateMachine->sendTrigger(EVT_block_challenge); //171
                // }

            //ç½ãè¦ã¤ããã //hinu
            }else if(g_challenge_stepNo == 172 && cur_rgb.r > 100 && cur_rgb.b > 100 && cur_rgb.g > 100 ){
                printf("ç½ï¼éér=%d,g=%d,b=%d\n",cur_rgb.r,cur_rgb.g,cur_rgb.b);

            //ç·ãè¦ã¤ããã //hinu
            }else if(g_challenge_stepNo == 172 && cur_rgb.r <= 13 && cur_rgb.b <= 50 && cur_rgb.g > 60 ){
                clock->sleep(300);//ã¹ã©ã­ã¼ã å¾ãå¤§ããã©ã¤ã³ãå·¦ã«å¤ãã¦ããæåã®é»ã©ã¤ã³ã«å¼ã£ããããªãããã«ã¹ãªã¼ã
                g_challenge_stepNo = 180;
                stateMachine->sendTrigger(EVT_block_challenge); //180 æ¸éãã¦æ¥è¿
                printf("ç·ï¼éér=%d,g=%d,b=%d\n",cur_rgb.r,cur_rgb.g,cur_rgb.b);

            //åç®ã©ã¤ã³ã®å¤§å¤æ ã¨ã¯ã­ã¹ãé»ãèµ¤ãé»è²ã®ï¼ãã¿ã¼ã³ã®ã¯ã­ã¹ããã
            }else if(g_challenge_stepNo == 180){
            
                //é»ãè¦ã¤ããããä¸åãã®ã©ã¤ã³ãã¬ã¼ã¹
                if(cur_rgb.g + cur_rgb.b <= 95 && cur_rgb.r <=50 && cur_rgb.g <=40 && cur_rgb.b <=60){
                    printf("é»ãè¦ã¤ããããä¸åãã®ã©ã¤ã³ãã¬ã¼ã¹ r=%d g=%d b=%d,distance=%lf,prevDis=%lf,å·®=%lf\n",cur_rgb.r,cur_rgb.g,cur_rgb.b,distance,prevDis,distance-prevDis);
                    g_challenge_stepNo = 190;
                    stateMachine->sendTrigger(EVT_block_challenge);//190

                    if( distance - prevDis < 830 ){
                        prevDegree360 = curDegree360;
                        root_no = 1;
                    }else{
                        prevDegree360 = curDegree360 - 15;
                        root_no = 3;
                    }
                    prevDisY=locY;
                    tempDis = locX;
                    g_challenge_stepNo = 191;
                //èµ¤ãè¦ã¤ããããèµ¤ãããã­ãã¯ã¸  ç´é²
                }else if(cur_rgb.r - cur_rgb.b >=40 && cur_rgb.g <65 && cur_rgb.r - cur_rgb.g >30){
                    printf("èµ¤ãè¦ã¤ããããèµ¤ãããã­ãã¯ã¸  ç´é²\n");
                    g_challenge_stepNo = 200;
                    stateMachine->sendTrigger(EVT_block_challenge); //200
                    g_challenge_stepNo = 201;
                    prevDegree360 = curDegree360;
                    prevDisY=locY;
                    tempDis = locX;
                    printf("èµ¤è²è¶ãã¾ãã\n");
                //é»è²ãè¦ã¤ããããå³ã«ç´é²ã®ã©ã¤ã³ãã¬ã¼ã¹
                }else if(cur_rgb.r + cur_rgb.g - cur_rgb.b >= 160 &&  cur_rgb.r - cur_rgb.g <= 30){
                    printf("é»è²ãè¦ã¤ããããå³ã«ç´é²ã®ã©ã¤ã³ãã¬ã¼ã¹\n");
                    g_challenge_stepNo = 210;
                    stateMachine->sendTrigger(EVT_block_challenge); //210
                    g_challenge_stepNo = 211;

                    clock->sleep(800);
                    stateMachine->sendTrigger(EVT_block_challenge); //211
                    g_challenge_stepNo = 212;
                    
                    printf("é»è²è¶ãã¾ãã1,distance=lf\n",distance);
                    prevDis = distance;
                    prevDisY=locY;
                    tempDis = locX;
                }
            //é»ã©ã¤ã³é²å¥ã®ç¶ã
            }else if(g_challenge_stepNo == 191 && own_abs(curDegree360 - prevDegree360) > 40){
                    g_challenge_stepNo = 192;
                    
            //åè»¢ä¸­ãé»ãè¦ã¤ããå ´å
            }else if(g_challenge_stepNo == 192 && (curRgbSum <= 150 || own_abs(curDegree360 - prevDegree360) >= 90)){
                    g_challenge_stepNo = 193;
            }else if(g_challenge_stepNo == 193 && own_abs(curDegree360 - prevDegree360) >= 125){
                    //ããã«ã¹ãã¬ã¼ããããã
                    printf("é»è²ã®ã»ãã¸,è§åº¦=%d,%dãè¨ç®=%d",curDegree360,prevDegree360,own_abs(curDegree360 - prevDegree360));
                    stateMachine->sendTrigger(EVT_block_challenge);
                    prevDis=distance;
                    prevDegree360 = curDegree360;
                    g_challenge_stepNo = 195;
            }else if(g_challenge_stepNo == 195 && own_abs(distance - prevDis) >= 90){
                    printf("ããããã©ã¤ã³ãã¬ã¼ã¹\n");
                    stateMachine->sendTrigger(EVT_line_on_p_cntl);
                    g_challenge_stepNo = 220;
                    //prevDegree360 = curDegree360;
            //èµ¤ã©ã¤ã³é²å¥ã®ç¶ã
           // }else if(g_challenge_stepNo == 201 && curDegree360 - prevDegree360 >= 75){ //èµ¤ã«ç´é²
            }else if(g_challenge_stepNo == 201 && curDegree360 - prevDegree360 >= 110){ //ã«ã¼ã
                    printf("èµ¤è²è¶ãã¾ãã2\n");
                    //stateMachine->sendTrigger(EVT_block_challenge); //201 ãèµ¤ã«ç´é²
                    stateMachine->sendTrigger(EVT_block_challenge); //201 ã«ã¼ã
                    //g_challenge_stepNo = 250;
                    g_challenge_stepNo = 250;
                    prevDis = distance;
                    root_no = 2;
            //é»è²ã©ã¤ã³é²å¥ã®ç¶ã
            }else if(g_challenge_stepNo==212 && cur_rgb.r + cur_rgb.g - cur_rgb.b <= 130){
                    g_challenge_stepNo = 213;
                    printf("é»è²è¶ãã¾ãã2 r=%d,g=%d,b=%d\n",cur_rgb.r , cur_rgb.g , cur_rgb.b);
                    root_no = 4;
            }else if((g_challenge_stepNo==213 && cur_rgb.r + cur_rgb.g - cur_rgb.b >= 160)|| ((g_challenge_stepNo==212 || g_challenge_stepNo==213) && distance-prevDis > 235)){ //hinu s
                    printf("é»è²è¶ãã¾ãã3 r=%d,g=%d,b=%d\n",cur_rgb.r , cur_rgb.g , cur_rgb.b);
                    g_challenge_stepNo = 213;
                    stateMachine->sendTrigger(EVT_line_on_pid_cntl); //213 hinuhinu
                    g_challenge_stepNo = 214;

            }else if(g_challenge_stepNo==214 && cur_rgb.r + cur_rgb.g - cur_rgb.b <= 130){
                    g_challenge_stepNo = 250;
            //é»ã©ã¤ã³ããã®é»è²ãè¦ã¤ããããã­ãã¯æ¹åã¸ã¿ã¼ã³
            }else if((g_challenge_stepNo == 220 || g_challenge_stepNo == 221 || g_challenge_stepNo == 195 || ( root_no==2 && g_challenge_stepNo == 250) ) && cur_rgb.r + cur_rgb.g - cur_rgb.b >= 160 ){   
                printf("ããã®prevDegree360=%d,azi=%d,sa=%d,locX=%lf,distance-prev=%lf\n",prevDegree360,curDegree360,prevDegree360-curDegree360,locX,distance-prevDis);
                //prevDegree180ã¯é»ã©ã¤ã³ä¾µå¥æãåè»¢å¾ã®ãã®
                if(distance-prevDis >= 500){
                accumuDegree = prevDegree360 - curDegree360 + 25; 
                }else if(distance-prevDis >= 380){
                accumuDegree = prevDegree360 - curDegree360 + 15; 
                }else if(distance-prevDis >= 230){
                accumuDegree = prevDegree360 - curDegree360 + 4; 
                }else if(distance-prevDis>=150){
                accumuDegree = prevDegree360 - curDegree360 + 3; 
                }else if(distance-prevDis<40){
                    accumuDegree = prevDegree360 - curDegree360 - 10; //hinuhinuhinu ããããã²ãã¨ãã¿ã©ãä¸¸ã«ã²ã£ããã
                }else if(distance-prevDis<65){
                    accumuDegree = prevDegree360 - curDegree360 - 8; //hinuhinuhinu
                }else if(distance-prevDis<86){
                    accumuDegree = prevDegree360 - curDegree360 - 5; //hinuhinuhinu
                }else if(distance-prevDis<107){
                    accumuDegree = prevDegree360 - curDegree360 - 4; //hinuhinuhinu
                }else {
                    accumuDegree = prevDegree360 - curDegree360 + 1;
                }
                prevDegree360 = curDegree360;
                g_challenge_stepNo = 230;
                stateMachine->sendTrigger(EVT_block_area_in); //230
                g_challenge_stepNo = 231;

            }else if(g_challenge_stepNo==231 && prevDegree360 - curDegree360 + accumuDegree > 111 ){
                prevDis = distance;
                prevDegree360=curDegree360;
                stateMachine->sendTrigger(EVT_block_challenge); //231
                g_challenge_stepNo = 232;
                printf("ããã¾ã§é»è²ã¨ãªã¢ï¼ locX=%lf,locY=%lf,prevDegree360=%d,azi=%d,sa=%d,gosa=%d\n",locX,locY,prevDegree360,curDegree360,prevDegree360 -curDegree360,accumuDegree);
            }else if(g_challenge_stepNo == 232 && ((root_no==1 && distance - prevDis > 200)|| (root_no==3 && distance - prevDis > 30))  && cur_rgb.r + cur_rgb.g - cur_rgb.b <= 130 ){ //hinuhinuhinu
                printf("ããã¾ã§é»è²ã¨ãªã¢ï¼ distance=%lf prevDis=%lf locX=%lf,locY=%lf,\n",distance,prevDis,locX,locY);
                stateMachine->sendTrigger(EVT_line_on_pid_cntl); //232
                g_challenge_stepNo = 250;

            //èµ¤ããä¸ã®é»ã©ã¤ã³ããã®é»ãè¦ã¤ããããã­ãã¯æ¹åã¸ã¿ã¼ã³ //hinu
            }else if(((root_no==3 && (g_challenge_stepNo == 220 || g_challenge_stepNo == 221 || g_challenge_stepNo == 195 ))|| ( root_no==2 && g_challenge_stepNo == 250)) && cur_rgb.g + cur_rgb.b <= 95 && cur_rgb.r <=50 && cur_rgb.g <=40 && cur_rgb.b <=60 && distance -prevDis > 170 ){   
                //accumuDegree = prevDegree360 - curDegree360 + 25;
                accumuDegree=-35;
                prevDegree360 = curDegree360;
                g_challenge_stepNo = 233;
                stateMachine->sendTrigger(EVT_line_on_pid_cntl); //233
                root_no=3;
                g_challenge_stepNo = 231;
                //accumuDegree = 25; //hinuhinuhinu             

            //èµ¤ãè¦ã¤ãããé»ãè¦ã¤ããã¾ã§ç´é²ããã®å¾ã©ã¤ã³ãã¬ã¼ã¹
            }else if(g_challenge_stepNo == 220 && cur_rgb.r - cur_rgb.b >= 40 && cur_rgb.g < 60 && cur_rgb.r - cur_rgb.g > 30){
                g_challenge_stepNo = 240;
                //ç´åã¾ã§ã©ã¤ã³ãã¬ã¼ã¹
                stateMachine->sendTrigger(EVT_block_area_in); //240
                g_challenge_stepNo = 241;
            //èµ¤ãé¢è±ããããã«ä»¥ä¸ã®åå²ã«ããã«ã©ã¼ãé çªã«ãã©ã
            }else if( cur_rgb.r - cur_rgb.b < 20 && g_challenge_stepNo == 241){
                g_challenge_stepNo = 242;
            }else if( cur_rgb.r - cur_rgb.b >=40 && g_challenge_stepNo == 242){
                g_challenge_stepNo = 243;
            //èµ¤ãééæãå¤§ããã©ã¤ã³ãå¤ããããã«ã¼ããã¦æ»ã
            }else if(g_challenge_stepNo == 243 && cur_rgb.r + cur_rgb.g + cur_rgb.b > 300){
                g_challenge_stepNo = 244;
                stateMachine->sendTrigger(EVT_block_challenge); //244
                g_challenge_stepNo = 245;
                clock->sleep(10);
                stateMachine->sendTrigger(EVT_line_on_pid_cntl); //245
                g_challenge_stepNo = 220;
            //ã©ã¤ã³ãå¤ãã¦ããªããã°ãé»ã®ã©ã¤ã³ãã¬ã¼ã¹ã¸
            }else if(g_challenge_stepNo == 243 && cur_rgb.r + cur_rgb.g + cur_rgb.b <= 100){
                g_challenge_stepNo = 246;
                stateMachine->sendTrigger(EVT_line_on_pid_cntl); //246 
                g_challenge_stepNo = 220;
            }else if(g_challenge_stepNo==250){    
                //printf(",garage_flg=%d,slalom_flg=%d,distance=%lf,g_angle=%d,curDegree360=%d, curSonarDis=%d, g_challenge_stepNo=%d,r=%d,g=%d,b=%d,locX=%lf,locY=%lf\n",garage_flg,slalom_flg,distance,g_angle,curDegree360, curSonarDis,g_challenge_stepNo,cur_rgb.r,cur_rgb.g,cur_rgb.b,locX,locY);
                //ãã­ãã¯ã«ç´é²ããã­ãã¯ã®é»è²ãè¦ã¤ããã
                if(cur_rgb.r + cur_rgb.g - cur_rgb.b >= 150){
                        printf("ãã­ãã¯GETãã¦ã»ãã tempDis=%lf,locY=%lf,prevDisY=%lf,locX=%lf,prevDisX=%lf\n",tempDis,locY,prevDisY,locX,prevDisX);                 
                        g_challenge_stepNo = 260;
                        //prevDegree360=curDegree360;
                }
            }
        }

        //ãã¼ãã¹ãã­ãã¯å¾å
        else if (garage_flg && g_challenge_stepNo >= 260 && !slalom_flg){
            //  if (g_challenge_stepNo >= 260 && g_challenge_stepNo <= 270){
            // //     if (++traceCnt && traceCnt > 10) {
            //             printf(",garage_flg=%d,slalom_flg=%d,distance=%lf,g_angle=%d,curDegree360=%d, curSonarDis=%d, g_challenge_stepNo=%d,r=%d,g=%d,b=%d,locX=%lf,locY=%lf\n",garage_flg,slalom_flg,distance,g_angle,curDegree360, curSonarDis,g_challenge_stepNo,cur_rgb.r,cur_rgb.g,cur_rgb.b,locX,locY);
            // //         traceCnt = 0;
            // //     }
            // }

            //ã¬ã¬ã¼ã¸ã«æ»ãã¹ããã¿ã¼ã³        
            if(g_challenge_stepNo == 260){
                //èµ°è¡ä½åé ­
                stateMachine->sendTrigger(EVT_block_area_in); //260
                accumuDegree =  getTurnDgree(prevDegree360,curDegree360);
                prevDegree360 = curDegree360;
                prevDis=distance;
                g_challenge_stepNo = 264;   //hinu s

                //èµ¤ããã¤ã³ãããã®ãã­ãã¯å°éã®å ´å
                if(root_no==2){ 
                    //åè»¢è§åº¦ãã»ãã
                    //turnDegree = 290; //èµ¤ç´é²
                    turnDegree = 170; //èµ¤ã«ã¼ã
                }else if(root_no==4){
                    turnDegree = 170;
                //é»ã©ã¤ã³ãé»è²ç´é²ããã®ãã­ãã¯å°éã®å ´å
                }else{
                    //åè»¢è§åº¦ã«80åº¦ãã»ãã
                    //turnDegree = 244 + accumuDegree;
                    turnDegree = 169;
                }
                accumuDegree = 0;
                printf("ï¼ï¼ï¼ãã¾ãã accumuDegree=%d\n",accumuDegree);

            }else if(g_challenge_stepNo == 264 && distance-prevDis > 150){ //hinu sããããã
                stateMachine->sendTrigger(EVT_block_challenge); //264
                g_challenge_stepNo = 261;
                printf("ï¼ï¼ï¼ãã¾ãã accumuDegree=%d\n",accumuDegree); //hinu s ããã¾ã§

            }else if(g_challenge_stepNo == 261 && accumuDegree > turnDegree){
                g_challenge_stepNo = 135;
                stateMachine->sendTrigger(EVT_block_challenge);
                clock->sleep(1000);
                g_challenge_stepNo = 261;
                stateMachine->sendTrigger(EVT_block_challenge); //261
                g_challenge_stepNo = 262;
                printf("ï¼ï¼ï¼ãã¾ãã accumuDegree=%dãturnDegree=%d\n",accumuDegree,turnDegree);

            }else if(g_challenge_stepNo == 261){ //è§åº¦ãæ¡ä»¶ã«è©²å½ããªãå ´åãå·®åãç´¯ç©ãã¦ããã
                accumuDegree += getTurnDgree(prevDegree360,curDegree360);
                prevDegree360 = curDegree360;
                //printf("ï¼ï¼ï¼ä¸­ accumuDegree=%dãturnDegree=%d\n",accumuDegree,turnDegree);
            //åæ¹ã«ä½ããªãç¶æ³ã«ãªã£ããé²è¡

//            }else if(g_challenge_stepNo == 262 ){ //hinuhinu
            }else if(g_challenge_stepNo == 262 && check_sonar(255,255) ){ //hinuhinu
//            }else if(g_challenge_stepNo == 262 && ((check_sonar(255,255) &&  accumuDegree > 175) || (accumuDegree > 185 && root_no==2) || (accumuDegree > 210 && root_no==1)) ){
                printf("èª¿æ´ä¸­ãåæ¹ã«ä½ããªãç¶æ³ã«ãªã£ããé²è¡ accumuDegree =%d curSonarDis=%d,curDegree360=%d\n",accumuDegree,curSonarDis,curDegree360);
                g_challenge_stepNo = 263;
                accumuDegree = 0;
                prevDegree360 = curDegree360;

            }else if(g_challenge_stepNo == 262){ //è§åº¦ãæ¡ä»¶ã«è©²å½ããªãå ´åãå·®åãç´¯ç©ãã¦ããã
                accumuDegree += getTurnDgree(prevDegree360,curDegree360);
                prevDegree360 = curDegree360;

            }else if(g_challenge_stepNo == 263){
                accumuDegree += getTurnDgree(prevDegree360,curDegree360);
                prevDegree360 = curDegree360;

                if(accumuDegree >= 17){ //255ãçºè¦ãã¦ããä½åº¦æ²ããããèª¿æ´
                    printf("è§åº¦èª¿æ´å¾ã«åé²ãã curSonarDis=%d,curDegree360=%d\n",curSonarDis,curDegree360);
                    stateMachine->sendTrigger(EVT_block_challenge); //263
                    g_challenge_stepNo = 270;
                    prevDis = distance;
                    prevDisX=locX;
                }
            }else if(g_challenge_stepNo == 270 && distance - prevDis > 380){
                //é»ç·ãã­ãã¯ãè¶ããã¾ã§ãä¸å®è·é¢ãèµ°è¡
                g_challenge_stepNo = 271;
            }else if(g_challenge_stepNo == 271 && check_sonar(255,255)){
                g_challenge_stepNo = 280;
            }else if(g_challenge_stepNo == 271 && check_sonar(1,254)){
                    //è¦çãéãã¦ãªããã°éåè»¢
                    stateMachine->sendTrigger(EVT_block_challenge);//271
                    prevDegree180=curDegree180;
                    printf("æ²ããåã¯è§åº¦ï¼=%d,curDegree360=%d,curSonarDis=%d\n",prevDegree180,curDegree360,curSonarDis);
                    g_challenge_stepNo = 272;
            }else if(g_challenge_stepNo == 272 && check_sonar(255,255)){
//            }else if(g_challenge_stepNo == 272 && (check_sonar(255,255)|| own_abs(prevDegree180 - curDegree180) > 30 )){
                    printf("æ²ãã£ãå¾ã¯è§åº¦ï¼=%d,curDegree360=%d,curSonarDis=%d\n",curDegree180,curDegree360,curSonarDis);
                    stateMachine->sendTrigger(EVT_block_challenge);//272
                    g_challenge_stepNo = 280;
            //ç·ãè¦ã¤ããããéåº¦åºå®                      
            }else if(g_challenge_stepNo == 280 && cur_rgb.r <= 13 && cur_rgb.b <= 50 && cur_rgb.g > 60){ 
                stateMachine->sendTrigger(EVT_block_challenge); //280
                g_challenge_stepNo = 281;
            //ä¸åº¦ç½ãéé
            }else if(g_challenge_stepNo == 281 && curRgbSum > 300){
                g_challenge_stepNo = 282;
            //ç·ãã¿ã¤ãããã«ã¼ãéå§
            }else if(g_challenge_stepNo == 282 && cur_rgb.r <= 13 && cur_rgb.b <= 50 && cur_rgb.g > 60 ){
                stateMachine->sendTrigger(EVT_block_challenge); //282
                g_challenge_stepNo = 283;
            //ä¸åº¦ç½ãéé
            }else if(g_challenge_stepNo == 283 && curRgbSum > 300){
                g_challenge_stepNo = 284;
            }else if(g_challenge_stepNo == 284  && cur_rgb.r + cur_rgb.g <= 150){  //éã¾ãã¯é»ãã¿ã¤ããããå®å¨ã«ã¿ã¼ã³)
                g_challenge_stepNo = 284;
                stateMachine->sendTrigger(EVT_block_challenge); //284
                g_challenge_stepNo = 285;
                clock->sleep(500);
            // ã¬ã¬ã¼ã¸ã®å¥¥ã®è·é¢ãæãããç´é²
            }else if(g_challenge_stepNo == 285 && check_sonar(35,250)){
                prevDegree360 = curDegree360;
                accumuDegree = 0;
                g_challenge_stepNo = 286;
            }else if(g_challenge_stepNo == 286){
                accumuDegree += getTurnDgree(prevDegree360,curDegree360);
                prevDegree360 = curDegree360;
                if(accumuDegree > 23){
                    stateMachine->sendTrigger(EVT_block_challenge); //286
                    g_challenge_stepNo = 290;
                }
            }else if(g_challenge_stepNo == 290 && check_sonar(0,16)){
                    stateMachine->sendTrigger(EVT_block_challenge); //290
                    garage_flg = false;
            }
        }//ã¬ã¬ã¼ã¸çµäº
    }else {
         //ã¹ã©ã­ã¼ã å°ç¨å¦çï¼å³ã³ã¼ã¹ï¼
        if(slalom_flg && !garage_flg){
            //ã­ã°åºå
            // if ((g_challenge_stepNo >= 140 && g_challenge_stepNo <= 141)){
            //      if (++traceCnt && traceCnt > 1) {
            //          printf(",locX=%lf,prevDisX=%lf,locX - prevDisX=%lf,locY=%lf,locY - prevDisY=%lf,distance=%lf,prevDis=%lf,g_angle=%d,curDegree180=%d, curSonarDis=%d, g_challenge_stepNo=%d,r+g+b=%d\n",locX,prevDisX,locX - prevDisX,locY,locY - prevDisY,distance,prevDis,g_angle,curDegree180, curSonarDis,g_challenge_stepNo,curRgbSum);
            //          traceCnt = 0;
            //      }
            // }

            //åæä½ç½®ã®ç¹å®
            if(g_challenge_stepNo == 10 && distance - prevDis > 30){
                prevDisX = locX;
                prevRgbSum = curRgbSum;
                if(curRgbSum < 100){
                    //ãã¨ãã¨é»ã®ä¸ã«ããå ´åãã©ã¤ã³ä¸æ¹é¢ã«åè»¢
                    prevDisX = locX;
                    printf("ãã¨ãã¨é»ã®ä¸\n");
                    g_challenge_stepNo = 20;
                }else{
                    //å·¦ã«ã¼ã
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    g_challenge_stepNo = 11;
                }
            }else if(g_challenge_stepNo == 11){
                //ã»ã³ãµã¼ã§é»ãæ¤ç¥ããå ´å
                if(curRgbSum < 100 ){
                    //ãã®å ´ã§ã©ã¤ã³ä¸æ¹é¢ã«åè»¢
                    prevDisX = locX;
                    g_challenge_stepNo = 20;
                }
                //å·¦ã«ã¼ãã§é»ãè¦ã¤ããããªãã£ãå ´åããªãã¼ã¹ãåã®ä½ç½®ã¾ã§æ»ã
                else if(own_abs(prevDisX - locX) > 175 ){
                    if(prevRgbSum - curRgbSum > 20){
                        //é»ã«è¿ã¥ãã¦ããããããå°ãé å¼µã
                    }else{
                        //é»ã®çé±ãè¦ããªããã°éèµ°ãã
                        stateMachine->sendTrigger(EVT_slalom_challenge);
                        g_challenge_stepNo = 12;
                    }
                }
            //å·¦ã«ã¼ãããæ»ã
            }else if(g_challenge_stepNo == 12){
                if(prevDisX - locX <= 0){
                    //å³ã«ã¼ãã¸ç§»è¡
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    g_challenge_stepNo = 13;
                
                //éä¸­ã§é»ãæ¤ç¥ããå ´åãå·¦ä¸ã¸ç§»å
                }else if(curRgbSum < 100 ){
                    //ãã®å ´ã§ã©ã¤ã³ä¸æ¹é¢ã«åè»¢
                    prevDis = distance;
                    g_challenge_stepNo = 13;
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    g_challenge_stepNo = 20;
                }

            }else if(g_challenge_stepNo == 13){
                //ã»ã³ãµã¼ã§é»ãæ¤ç¥ããå ´å
                if(curRgbSum < 100 ){
                    //ãã®å ´ã§ã©ã¤ã³ä¸æ¹é¢ã«åè»¢
                    prevDisX = locX;
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    g_challenge_stepNo = 20;
                }        

            }else if(g_challenge_stepNo == 20 && curDegree180 >= -30){
                //ãã®å ´ã§å·¦åè»¢
                g_challenge_stepNo = 21;
                stateMachine->sendTrigger(EVT_slalom_challenge);//21
                root_no = 1;
                printf("ä¸ããåè»¢ %d\n",curDegree180);

            }else if(g_challenge_stepNo == 20 && curDegree180 < -30){
                //ãã®å ´ã§å³åè»¢
                g_challenge_stepNo = 22;
                stateMachine->sendTrigger(EVT_slalom_challenge);//22
                root_no = 2;
                printf("ä¸ããåè»¢ã%d\n",curDegree180);

            }else if((g_challenge_stepNo == 21 && curDegree180 <= -30) || (g_challenge_stepNo == 22 && curDegree180 >= -30)){
                //è§åº¦ãä¸å®è§åº¦ã«ãªã£ãããåæ­¢ãç´é²
                printf("è§åº¦ã%d\n",curDegree180);
                g_challenge_stepNo = 23;
                stateMachine->sendTrigger(EVT_slalom_challenge); //23
                prevDis = distance;
                g_challenge_stepNo = 24;
            // ä¸ã«é²ã
            } else if(g_challenge_stepNo == 24){
                if((root_no == 1 && own_abs(distance - prevDis) > 215) || (root_no ==2 && own_abs(distance - prevDis) > 150)){ // ããå¤ãã
                    printf(",é»ã©ã¤ã³ä¸ååã«é²ã prevDis=%lf, distance=%lf\n", prevDis, distance);
                    stateMachine->sendTrigger(EVT_slalom_challenge); //24
                    g_challenge_stepNo = 30;
                }
            //é²è¡æ¹åã«å¯¾ãã¦æ¨ªè»¸ã«é²ãã ããè§åº¦ãæ»ã
            }else if(g_challenge_stepNo == 30){
                if((root_no == 1 && curDegree180 > prevDegree180 + 7) || (root_no == 2 && curDegree180 > prevDegree180 + 21)){
                    printf(",é²è¡æ¹åã«å¯¾ãã¦æ¨ªè»¸ã«é²ãã ããè§åº¦ãæ»ãroot_no=%d prevDegree180=%d curDegree180=%d\n",root_no,prevDegree180,curDegree180);
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    g_challenge_stepNo = 40;
                    prevSonarDis = curSonarDis;
                    prevDis = distance;
                    prevDisX = locX;
                }
            // }else if (g_challenge_stepNo == 40 && curSonarDis > prevSonarDis && distance - prevDis < 150){
            //         printf(",ä¸åãã«èª¿æ´ãã root_no=%d prevSonarDis=%d curSonarDis=%d\n",root_no,prevSonarDis,curSonarDis);
            //         g_challenge_stepNo = 31;
            // }else if (g_challenge_stepNo == 31 && curSonarDis <= prevSonarDis) {
            //     printf(",èª¿æ´å®äº root_no=%d prevSonarDis=%d curSonarDis=%d\n",root_no,prevSonarDis,curSonarDis);
            //     g_challenge_stepNo = 32;
            //     stateMachine->sendTrigger(EVT_slalom_challenge);
            //     g_challenge_stepNo = 40;
             //  ï¼ã¤ç®ã®éå®³ç©ã«æ¥è¿ãããåããå¤ãã
            }else if (g_challenge_stepNo == 40 && (locY - prevDisY > 560 || check_sonar(0,5))){
                printf(",ï¼ã¤ç®ã®éå®³ç©ã«æ¥è¿ãããåããå¤ãã,g_challenge_stepNo=%d,locY = %lf,prevDisY = %lf ,curSonarDis=%d,locX=%lf,prevDisX=%lf\n",g_challenge_stepNo,locY,prevDisY,curSonarDis,locX,prevDisX);
                stateMachine->sendTrigger(EVT_slalom_challenge);
                g_challenge_stepNo = 50;
                prevRgbSum = curRgbSum;
                line_over_flg = false;
                prevRgbSum = curRgbSum;
            //  è¦çãæ´ãããå·¦ä¸ã«åé²ãã
            }else if(g_challenge_stepNo == 50  && check_sonar(20,255) && own_abs(curDegree180 - prevDegree180) > 70){
                printf(",è¦çãæ´ããã¨ããã§åé²ãã ã½ãã¼=%d curDegree180=%d prevDegree180=%d",curSonarDis,curDegree180,prevDegree180);
                stateMachine->sendTrigger(EVT_slalom_challenge);
                g_challenge_stepNo = 60;
                prevRgbSum = curRgbSum;
                line_over_flg = false;
            //  é»ã©ã¤ã³ãè¶ããã¾ã§åé²ããè¶ãããåããèª¿æ´ãï¼ã¤ç®ã®éå®³ç©ã«æ¥è¿ãã
            }else if (g_challenge_stepNo == 60 && !line_over_flg){
                if (curRgbSum < 100) {
                    prevRgbSum = curRgbSum;
                }
                if(prevRgbSum < 100 && curRgbSum > 140){
                    printf(",é»ã©ã¤ã³ãè¶ãããåããèª¿æ´ãéå®³ç©ã«æ¥è¿ãã\n");
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    //prevDis=distance;
                    prevDisX = locX;
                    g_challenge_stepNo = 61;
                    prevDegree180 = curDegree180;
                    line_over_flg = true;
                    g_challenge_stepNo = 71;
                }else if(locY - prevDisY > 900){
                    //ï¼ãã³æåããé»ã©ã¤ã³ãè¶ããã«æ¨ªã«é²ãã å ´åã®ä¾å¤å¦ç
                    printf("ä¾å¤ééãé»ã©ã¤ã³ã®ç®æ");
                    g_challenge_stepNo = 61;
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    g_challenge_stepNo = 110;
                }
                
            }else if(g_challenge_stepNo == 71 && (locY - prevDisY > 715 || check_sonar(0,5))){
                    printf("ï¼ãã³æå locY=%lf, prevDisY=%lf,curSonarDis=%d\n",locY, prevDisY,curSonarDis);
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    g_challenge_stepNo = 80;
                    line_over_flg = true;
                    prevDegree180 = curDegree180;
            // è¦çãæ´ãããå·¦ä¸ã«åé²ãã
            }else if (g_challenge_stepNo == 80  && own_abs(prevDegree180 - curDegree180) > 60){
                    printf(",è¦çãæ´ãããå·¦ä¸ã«åé²ãã curDegree180=%d\n",curDegree180);
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    accumuDegree = own_abs(-33 - curDegree180); 
                    g_challenge_stepNo = 90;
                    prevRgbSum = curRgbSum;
                    line_over_flg = false;
            // é»ã©ã¤ã³ãè¶ããã¾ã§åé²ããè¶ãããåããèª¿æ´ãã
            }else if (g_challenge_stepNo == 90 && !line_over_flg){
                if (curRgbSum < 100) {
                    prevRgbSum = curRgbSum;
                    prevDis=distance;
                    tempDis = locX;
                }
                if(prevRgbSum < 100 && curRgbSum > 150 && own_abs(distance - prevDis) > 20){
                    printf(",é»ã©ã¤ã³ãè¶ãããåããèª¿æ´ããprevDisX=%lf  locX = %lf \n",prevDisX,locX);
                    stateMachine->sendTrigger(EVT_slalom_challenge); //90
                    prevDegree180 = curDegree180;
                    g_challenge_stepNo = 99;
                    line_over_flg = true;
                }

            //ï¼ãã³åé¿ä¸­ã«é»ã©ã¤ã³ã«è¡ã£ã¦ãã¾ããã¿ã¼ã³
            }else if( (g_challenge_stepNo == 80 && curRgbSum < 100) || (g_challenge_stepNo == 71 && curRgbSum < 100) ){
                    g_challenge_stepNo = 90;
                    clock->sleep(300);
                    printf(",ä¾å¤å¦çé»ã©ã¤ã³ãè¶ãããåããèª¿æ´ããprevDisX=%lf  locX = %lf \n",prevDisX,locX);
                    stateMachine->sendTrigger(EVT_slalom_challenge); //90
                    prevDegree180 = curDegree180;
                    g_challenge_stepNo = 99;
                    prevDisX=locX;
                    tempDis = locX;
                    line_over_flg = true;

            //  ï¼ã¤ç®ã®éå®³ç©ã«æ¥è¿ãã
            }else if(g_challenge_stepNo == 99 && own_abs(curDegree180 - prevDegree180) > 20 + accumuDegree){ 
//            }else if(g_challenge_stepNo == 100 && (own_abs(curDegree180 - prevDegree180) > 52 + accumuDegree || curDegree180 > 5)){ 
                printf(",ï¼ã¤ç®ã®éå®³ç©ã«æ¥è¿ãããlocY=%lf,prevDisY=%lf,prevDegree180=%d ,curDegree180=%d,locX=%lf,prevDisX=%lf, curSonarDis=%d\n",locY,prevDisY,prevDegree180,curDegree180,locX,prevDisX,curSonarDis);
                stateMachine->sendTrigger(EVT_slalom_challenge);
//                prevDisX = locX;
//                prevDis=distance;
                prevDegree180 = curDegree180;
                g_challenge_stepNo = 100;
            }else if(g_challenge_stepNo == 100 && check_sonar(0,26) && own_abs(curDegree180 - prevDegree180) > 13){ 
                printf(",ï¼ã¤ç®ã®éå®³ç©ã«æ¥è¿ãããlocY=%lf,prevDisY=%lf,prevDegree180=%d ,curDegree180=%d,locX=%lf,prevDisX=%lf, curSonarDis=%d\n",locY,prevDisY,prevDegree180,curDegree180,locX,prevDisX,curSonarDis);
                stateMachine->sendTrigger(EVT_slalom_challenge);
                prevDisX = locX;
                prevDis = distance;
                prevDegree180 = curDegree180;
                g_challenge_stepNo = 101;
            }else if(g_challenge_stepNo == 101 && (own_abs(distance - prevDis) > 250 || check_sonar(0,5))){
                stateMachine->sendTrigger(EVT_slalom_challenge);
                prevDegree180 = curDegree180;
                g_challenge_stepNo = 112;
                printf("ï¼ï¼ï¼éãã¾ãã curSonarDis=%d, curRgbSum=%dp, revDegree180=%d, curDegree180=%d\n",curSonarDis, curRgbSum,prevDegree180,curDegree180);
            }else if(g_challenge_stepNo == 112 && own_abs(curDegree180 - prevDegree180) > 50 ){
                stateMachine->sendTrigger(EVT_slalom_challenge);
                g_challenge_stepNo = 113;
                printf("ï¼ï¼ï¼éãã¾ãã curRgbSum=%d.prevDegree180=%d, curDegree180=%d\n",curRgbSum,prevDegree180,curDegree180);
            }else if (g_challenge_stepNo == 113 && distance - prevDis >= 150){
//            }else if ((g_challenge_stepNo == 113 || g_challenge_stepNo == 112 || g_challenge_stepNo == 111) && locY - prevDisY >= prevDis ){
                    g_challenge_stepNo = 131;
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    printf("ï¼ï¼ï¼éãã¾ãã curRgbSum=%d\n",curRgbSum);
             }else if (g_challenge_stepNo == 131 && curRgbSum <= 100){
                    g_challenge_stepNo = 1132;
                    printf("ï¼ï¼ï¼ï¼éãã¾ãã curRgbSum=%d\n",curRgbSum);
             }else if (g_challenge_stepNo == 1132 && curRgbSum > 130){
                    g_challenge_stepNo = 1133;
                    printf("ï¼ï¼ï¼éãã¾ãã curRgbSum=%d\n",curRgbSum);
//             }else if (g_challenge_stepNo == 1133 && curRgbSum <= 100){
             }else if ((g_challenge_stepNo == 1133 || (g_challenge_stepNo == 131 && !line_over_flg))&& curRgbSum <= 100){
                    g_challenge_stepNo = 133;
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                    prevDegree180 = curDegree180;
                    g_challenge_stepNo = 134;
                     printf("ã¨ã¾ãã¾ããcurRgbSum=%d\n",curRgbSum);

             }else if((g_challenge_stepNo == 101 || g_challenge_stepNo == 112 || g_challenge_stepNo == 113||g_challenge_stepNo == 131||g_challenge_stepNo == 1132||g_challenge_stepNo == 1133) && curRgbSum<=100 ){
                    line_over_flg = false;

//             }else if(g_challenge_stepNo ==134 && (check_sonar(1,254))){
             }else if(g_challenge_stepNo ==134){
             //}else if(g_challenge_stepNo ==140 && (check_sonar(85,254) || own_abs(curDegree180 - prevDegree180) > 95)){
                 printf(",ã½ãã¼ã«å¼ã£ããã£ã,g_challenge_stepNo=%d,ã½ãã¼=%d,è§åº¦=%d, curRgbSum=%d\n",g_challenge_stepNo,curSonarDis,own_abs(curDegree180 - prevDegree180),curRgbSum);
                 g_challenge_stepNo = 140;
                 prevDegree180 = curDegree180;

            // // ç´é²ãã¹ã©ã­ã¼ã ãéãã hinutest
            }else if(g_challenge_stepNo == 140 && own_abs(curDegree180 - prevDegree180) > 64){  // ããå¤ãã
                int32_t tempSonarDis = curSonarDis;
                printf(",éã£ã1,g_challenge_stepNo=%d,ã½ãã¼=%d,è§åº¦=%d,curDegree180=%d,prevDegree180=%d\n",g_challenge_stepNo,curSonarDis,own_abs(curDegree180 - prevDegree180),curDegree180,prevDegree180);
                //g_challenge_stepNo = 135;
                //stateMachine->sendTrigger(EVT_slalom_challenge);
                // //if (check_sonar(0,5)){
                // if ( tempSonarDis <= 5 ){
                //     printf("éã£ã2\n");
                //     prevDegree180 = curDegree180;
                //     g_challenge_stepNo = 136;
                //     stateMachine->sendTrigger(EVT_slalom_challenge);
                //     //if (own_abs(curDegree180 - prevDegree180) > 10){
                //         printf(",ç´é²ãã¹ã©ã­ã¼ã ãéãã,g_challenge_stepNo=%d,ã½ãã¼=%d,è§åº¦=%d, curRgbSum=%d\n",g_challenge_stepNo,curSonarDis,own_abs(curDegree180 - prevDegree180),curRgbSum);
                //         g_challenge_stepNo = 141;
                //         stateMachine->sendTrigger(EVT_slalom_challenge);
                //     //}
                // }else {
                    printf(",ç´é²ãã¹ã©ã­ã¼ã ãéãã,g_challenge_stepNo=%d,ã½ãã¼=%d,è§åº¦=%d, curRgbSum=%d\n",g_challenge_stepNo,curSonarDis,own_abs(curDegree180 - prevDegree180),curRgbSum);
                    g_challenge_stepNo = 141;
                    stateMachine->sendTrigger(EVT_slalom_challenge);
                //}
                prevDis = distance;
                armMotor->setPWM(30);
                g_challenge_stepNo = 150;
            }

            // // ã©ã¤ã³ãã¬ã¼ã¹ãã¿ã¼ã³hinutest
            // }else if(g_challenge_stepNo == 142 && own_abs(curDegree180 - prevDegree180) > 55){
            //     printf(",ã©ã¤ã³ãã¬ã¼ã¹ã«ç§»ã,g_challenge_stepNo=%d,ã½ãã¼=%d,è§åº¦=%d, curRgbSum=%d\n",g_challenge_stepNo,curSonarDis,own_abs(curDegree180 - prevDegree180),curRgbSum);
            //     stateMachine->sendTrigger(EVT_line_on_pid_cntl);
            //     prevDis = distance;
            //     g_challenge_stepNo = 141;

            // }else if(g_challenge_stepNo == 141 && own_abs(distance - prevDis) > 230){
            // //}else if(g_challenge_stepNo == 141){
            //     printf(",ç´é²ãã¹ã©ã­ã¼ã ãéãã,g_challenge_stepNo=%d,ã½ãã¼=%d,è§åº¦=%d, curRgbSum=%d\n",g_challenge_stepNo,curSonarDis,own_abs(curDegree180 - prevDegree180),curRgbSum);
            //     stateMachine->sendTrigger(EVT_block_area_in);
            //     prevDis = distance;
            //     armMotor->setPWM(30);
            //     g_challenge_stepNo = 150;
            // }

            // ã¹ã©ã­ã¼ã éãã¦ãã©ã°Off
            if(g_angle > 6 && g_challenge_stepNo <= 150 && g_challenge_stepNo >= 130){
                printf("ã¹ã©ã­ã¼ã ãªã\n");
                g_challenge_stepNo = 150;
                stateMachine->sendTrigger(EVT_slalom_challenge);
                state = ST_block;
                slalom_flg = false;
                garage_flg = true;
                locX = 0;
                locY = 0;
                distance = 0;
                prevAngL =0; 
                prevAngR =0; 
                azimuth = 0; 
                leftMotor->reset(); 
                rightMotor->reset(); 
                armMotor->setPWM(-100); 
                curAngle = 0;
                prevAngle = 0;
                root_no=0;
            }
        }

        //ãã¼ãã¹ãã­ãã¯ï¼ã¬ã¬ã¼ã¸å°ç¨å¦ç
        if (garage_flg && !slalom_flg && g_challenge_stepNo < 260 ){
            //  if (g_challenge_stepNo >= 150 && g_challenge_stepNo <= 170){
            // //     if (++traceCnt && traceCnt > 10) {
            //             printf(",garage_flg=%d,slalom_flg=%d,distance=%lf,g_angle=%d,curDegree180=%d,prevDegree180=%d. curSonarDis=%d, g_challenge_stepNo=%d,r=%d,g=%d,b=%d,locX=%lf,locY=%lf\n",garage_flg,slalom_flg,distance,g_angle,curDegree180,prevDegree180, curSonarDis,g_challenge_stepNo,cur_rgb.r,cur_rgb.g,cur_rgb.b,locX,locY);
            // //         traceCnt = 0;
            // //     }
            //}

            //ã¬ã¬ã¼ã¸ONå¾ãè·é¢ãä¸é¨æ®ãããã§ãããããè·é¢ããªã»ããããããã¨ãç¢ºèª
            if(g_challenge_stepNo == 150 && distance < 100 && distance > 1){
                g_challenge_stepNo = 151;
            }else if( g_challenge_stepNo == 151 && distance > 90){
                // ã½ãã¼ç¨¼ååè»¢ãæ¹åãèª¿æ´
                g_challenge_stepNo = 155;
                stateMachine->sendTrigger(EVT_block_challenge); //155
                clock->sleep(1000);
                printf("ã½ãã¼ç¨¼ååè»¢ãæ¹åãèª¿æ´ curSonarDis=%d,curDegree180=%d\n",curSonarDis,curDegree180);
                g_challenge_stepNo = 151;
                stateMachine->sendTrigger(EVT_block_challenge); //151
                g_challenge_stepNo = 152;
            }else if(g_challenge_stepNo == 152 && check_sonar(70,255)){
                printf("ã½ãã¼ã¬ã¬ã¼ã¸å¤ã curSonarDis=%d,curDegree180=%d\n",curSonarDis,curDegree180);
                prevDegree180 = curDegree180 + 30;
                stateMachine->sendTrigger(EVT_block_challenge); //152
                g_challenge_stepNo = 154;
                root_no=1;
            }else if (g_challenge_stepNo == 152 && check_sonar(1,70)){
                printf("ã½ãã¼ã¬ã¬ã¼ã¸å curSonarDis=%d,curDegree180=%d\n",curSonarDis,curDegree180);
                prevSonarDis = curSonarDis;
                prevDegree180 = curDegree180;
                stateMachine->sendTrigger(EVT_block_challenge); //152
                g_challenge_stepNo = 153;
                root_no=2;
            }else if (g_challenge_stepNo == 153 && check_sonar(80,255) ){
//            }else if (g_challenge_stepNo == 153 && (check_sonar(80,255) || own_abs(curDegree180 - prevDegree180) > 24)){
                printf("ã½ãã¼ã¬ã¬ã¼ã¸ããå¤ãã curSonarDis=%d,prevSonarDis=%d,curDegree180=%d,prevDegree180=%d\n",curSonarDis,prevSonarDis,curDegree180,prevDegree180);
                g_challenge_stepNo = 154;
                prevDegree180 = curDegree180;
            }else if (g_challenge_stepNo == 153){
                prevSonarDis = curSonarDis;
            //ä¸å®è§åº¦åè»¢
            }else if(g_challenge_stepNo == 154 && own_abs(curDegree180 - prevDegree180) > 48){
                //stateMachine->sendTrigger(EVT_block_challenge); //154
                g_challenge_stepNo = 170;
            //åç®ã©ã¤ã³æ¹åã¸é²è¡
            }else if(g_challenge_stepNo == 170 ){
                printf("åç®ã©ã¤ã³æ¹åã¸é²è¡ curSonarDis=%d,prevSonarDis=%d,curDegree180=%d,prevDegree180=%d\n",curSonarDis,prevSonarDis,curDegree180,prevDegree180);
                prevDis = distance;
                // åç®ã©ã¤ã³ã«æ¥è¿
                stateMachine->sendTrigger(EVT_block_challenge); //170
                g_challenge_stepNo = 171;
            
            //ç·ãè¦ã¤ããã //hinu
            }else if((g_challenge_stepNo == 171 || g_challenge_stepNo == 174) && cur_rgb.r <= 13 && cur_rgb.b <= 50 && cur_rgb.g > 60 ){
                clock->sleep(800);//ã¹ã©ã­ã¼ã å¾ãå¤§ããã©ã¤ã³ãå·¦ã«å¤ãã¦ããæåã®é»ã©ã¤ã³ã«å¼ã£ããããªãããã«ã¹ãªã¼ã
                printf("ç·ï¼éér=%d,g=%d,b=%d\n",cur_rgb.r,cur_rgb.g,cur_rgb.b);
                g_challenge_stepNo = 172;

            //é»oréãè¦ã¤ããã//hinu
            }else if(g_challenge_stepNo == 171 && (curRgbSum<=100 || cur_rgb.b - cur_rgb.r >=60)){
                //printf("é»oréãçµç±ãå·¦å¯ãã«è½ã¡ã¾ãã distance-prevDis=%lf\n",own_abs(distance-prevDis));
                printf("ããããè¿½å ã³ã¼ã distance=%d\n", own_abs(distance-prevDis));
                
                 //ããããè¿½å ã³ã¼ã sano_t
                if(distance-prevDis > 35 ){
                    g_challenge_stepNo = 173;
                    stateMachine->sendTrigger(EVT_block_challenge);
                   

                    g_challenge_stepNo = 170;
                    stateMachine->sendTrigger(EVT_block_challenge);
                }
                prevDis=distance;
                g_challenge_stepNo = 174;
                printf("ããããè¿½å ã³ã¼ã g_challenge_stepNo=%d,distance=%d\n", g_challenge_stepNo,own_abs(distance-prevDis));
                // //ã¬ã¬ã¼ã¸å¤ãªãããã«æ²ãã
                // if(root_no == 1){
                //     stateMachine->sendTrigger(EVT_block_challenge); //171
                // }

            //ç½ãè¦ã¤ããã //hinu
            }else if(g_challenge_stepNo == 172 && cur_rgb.r > 100 && cur_rgb.b > 100 && cur_rgb.g > 100 ){
                printf("ç½ï¼éér=%d,g=%d,b=%d\n",cur_rgb.r,cur_rgb.g,cur_rgb.b);

            //ç·ãè¦ã¤ããã //hinu
            }else if(g_challenge_stepNo == 172 && cur_rgb.r <= 13 && cur_rgb.b <= 50 && cur_rgb.g > 60 ){
                clock->sleep(300);//ã¹ã©ã­ã¼ã å¾ãå¤§ããã©ã¤ã³ãå·¦ã«å¤ãã¦ããæåã®é»ã©ã¤ã³ã«å¼ã£ããããªãããã«ã¹ãªã¼ã
                g_challenge_stepNo = 180;
                stateMachine->sendTrigger(EVT_block_challenge); //180 æ¸éãã¦æ¥è¿
                printf("ç·ï¼éér=%d,g=%d,b=%d\n",cur_rgb.r,cur_rgb.g,cur_rgb.b);

            //åç®ã©ã¤ã³ã®å¤§å¤æ ã¨ã¯ã­ã¹ãé»ãèµ¤ãé»è²ã®ï¼ãã¿ã¼ã³ã®ã¯ã­ã¹ããã
            }else if(g_challenge_stepNo == 180){
            
                //é»ãè¦ã¤ããããä¸åãã®ã©ã¤ã³ãã¬ã¼ã¹
                if(cur_rgb.g + cur_rgb.b <= 95 && cur_rgb.r <=50 && cur_rgb.g <=40 && cur_rgb.b <=60){
                    printf("é»ãè¦ã¤ããããä¸åãã®ã©ã¤ã³ãã¬ã¼ã¹ r=%d g=%d b=%d,distance=%lf,prevDis=%lf,å·®=%lf\n",cur_rgb.r,cur_rgb.g,cur_rgb.b,distance,prevDis,distance-prevDis);
                    g_challenge_stepNo = 190;
                    stateMachine->sendTrigger(EVT_block_challenge);//190

                    if( distance - prevDis < 830 ){
                        prevDegree360 = curDegree360;
                        root_no = 1;
                    }else{
                        prevDegree360 = curDegree360 - 15;
                        root_no = 3;
                    }
                    prevDisY=locY;
                    tempDis = locX;
                    g_challenge_stepNo = 191;
                //èµ¤ãè¦ã¤ããããèµ¤ãããã­ãã¯ã¸  ç´é²
                }else if(cur_rgb.r - cur_rgb.b >= 40 && cur_rgb.g < 65 && cur_rgb.r - cur_rgb.g > 30){
                    printf("èµ¤ãè¦ã¤ããããèµ¤ãããã­ãã¯ã¸  ç´é²\n");
                    g_challenge_stepNo = 200;
                    stateMachine->sendTrigger(EVT_block_challenge); //200
                    g_challenge_stepNo = 201;
                    prevDegree360 = curDegree360;
                    prevDisY=locY;
                    tempDis = locX;
                    printf("èµ¤è²è¶ãã¾ãã\n");
                    root_no=2;
                //é»è²ãè¦ã¤ããããå³ã«ç´é²ã®ã©ã¤ã³ãã¬ã¼ã¹
                }else if(cur_rgb.r + cur_rgb.g - cur_rgb.b >= 160 &&  cur_rgb.r - cur_rgb.g <= 30){
                    printf("é»è²ãè¦ã¤ããããå³ã«ç´é²ã®ã©ã¤ã³ãã¬ã¼ã¹\n");
                    g_challenge_stepNo = 210;
                    stateMachine->sendTrigger(EVT_block_challenge); //210
                    g_challenge_stepNo = 211;

                    clock->sleep(800);
                    stateMachine->sendTrigger(EVT_block_challenge); //211
                    g_challenge_stepNo = 212;
                    
                    printf("é»è²è¶ãã¾ãã1,distance=lf\n",distance);
                    prevDis = distance;
                    prevDisY=locY;
                    tempDis = locX;
                    root_no=4;
                }
            //é»ã©ã¤ã³é²å¥ã®ç¶ã
            }else if(g_challenge_stepNo == 191 && own_abs(curDegree360 - prevDegree360) > 40){
                    g_challenge_stepNo = 192;
                    
            //åè»¢ä¸­ãé»ãè¦ã¤ããå ´å
            }else if(g_challenge_stepNo == 192 && (curRgbSum <= 150 || own_abs(curDegree360 - prevDegree360) >= 90)){
                    g_challenge_stepNo = 193;
            }else if(g_challenge_stepNo == 193 && own_abs(curDegree360 - prevDegree360) >= 131){
                    //ããã«ã¹ãã¬ã¼ããããã
                    printf("é»è²ã®ã»ãã¸,è§åº¦=%d,%dãè¨ç®=%d",curDegree360,prevDegree360,own_abs(curDegree360 - prevDegree360));
                    stateMachine->sendTrigger(EVT_block_challenge);
                    prevDis=distance;
                    prevDegree360 = curDegree360;
                    g_challenge_stepNo = 195;
            }else if(g_challenge_stepNo == 195 && own_abs(distance - prevDis) >= 90){
                    printf("ããããã©ã¤ã³ãã¬ã¼ã¹\n");
                    stateMachine->sendTrigger(EVT_line_on_p_cntl);
                    g_challenge_stepNo = 220;
                    //prevDegree360 = curDegree360;
            //èµ¤ã©ã¤ã³é²å¥ã®ç¶ã
           // }else if(g_challenge_stepNo == 201 && curDegree360 - prevDegree360 >= 75){ //èµ¤ã«ç´é²
            }else if(g_challenge_stepNo == 201 && curDegree360 - prevDegree360 >= 125){ //ã«ã¼ã
                    printf("èµ¤è²è¶ãã¾ãã2\n");
                    //stateMachine->sendTrigger(EVT_block_challenge); //201 ãèµ¤ã«ç´é²
                    stateMachine->sendTrigger(EVT_block_challenge); //201 ã«ã¼ã
                    //g_challenge_stepNo = 250;
                    g_challenge_stepNo = 250;
                    prevDis = distance;
                    root_no = 2;
            //é»è²ã©ã¤ã³é²å¥ã®ç¶ã
            }else if(g_challenge_stepNo==212 && cur_rgb.r + cur_rgb.g - cur_rgb.b <= 130){
                    g_challenge_stepNo = 213;
                    printf("é»è²è¶ãã¾ãã2 r=%d,g=%d,b=%d\n",cur_rgb.r , cur_rgb.g , cur_rgb.b);
                    root_no = 4;
            }else if((g_challenge_stepNo==213 && cur_rgb.r + cur_rgb.g - cur_rgb.b >= 160)|| ((g_challenge_stepNo == 212 || g_challenge_stepNo == 213) && distance-prevDis > 233)){
                    printf("é»è²è¶ãã¾ãã3 r=%d,g=%d,b=%d\n",cur_rgb.r , cur_rgb.g , cur_rgb.b);
                    g_challenge_stepNo = 213;
                    stateMachine->sendTrigger(EVT_line_on_pid_cntl); //213
                    g_challenge_stepNo = 214;

            }else if(g_challenge_stepNo==214 && cur_rgb.r + cur_rgb.g - cur_rgb.b <= 130){
                    g_challenge_stepNo = 250;
            //é»ã©ã¤ã³ããã®é»è²ãè¦ã¤ããããã­ãã¯æ¹åã¸ã¿ã¼ã³
            }else if((g_challenge_stepNo == 220 || g_challenge_stepNo == 221 || g_challenge_stepNo == 195 || ( root_no==2 && g_challenge_stepNo == 250) ) && cur_rgb.r + cur_rgb.g - cur_rgb.b >= 160 ){   
                printf("ããã®prevDegree360=%d,azi=%d,sa=%d,locX=%lf,distance-prev=%lf\n",prevDegree360,curDegree360,prevDegree360-curDegree360,locX,distance-prevDis);
                //prevDegree180ã¯é»ã©ã¤ã³ä¾µå¥æãåè»¢å¾ã®ãã®
                if(distance-prevDis >= 500){
                accumuDegree = prevDegree360 - curDegree360 + 25; 
                }else if(distance-prevDis >= 380){
                accumuDegree = prevDegree360 - curDegree360 + 13; 
                }else if(distance-prevDis >= 230){
                accumuDegree = prevDegree360 - curDegree360 + 4; 
                }else if(distance-prevDis>=150){
                accumuDegree = prevDegree360 - curDegree360 + 3; 
                }else if(distance-prevDis<40){
                    accumuDegree = prevDegree360 - curDegree360 - 13; 
                }else if(distance-prevDis<60){
                    accumuDegree = prevDegree360 - curDegree360 - 11; 
                }else if(distance-prevDis<80){
                    accumuDegree = prevDegree360 - curDegree360 - 7; 
                }else if(distance-prevDis<107){
                    accumuDegree = prevDegree360 - curDegree360 - 5; 
                }else {
                    accumuDegree = prevDegree360 - curDegree360 + 1;
                }
                prevDegree360 = curDegree360;
                g_challenge_stepNo = 230;
                stateMachine->sendTrigger(EVT_block_area_in); //230
                g_challenge_stepNo = 231;

            }else if(g_challenge_stepNo==231 && prevDegree360 - curDegree360 + accumuDegree > 111 ){
                prevDis = distance;
                stateMachine->sendTrigger(EVT_block_challenge); //231
                g_challenge_stepNo = 232;
                prevDegree360=curDegree360;
                printf("ããã¾ã§é»è²ã¨ãªã¢ï¼ locX=%lf,locY=%lf,prevDegree360=%d,azi=%d,sa=%d,gosa=%d\n",locX,locY,prevDegree360,curDegree360,prevDegree360 -curDegree360,accumuDegree);
            }else if(g_challenge_stepNo == 232 && ((root_no==1 && distance - prevDis > 200)|| (root_no==3 && distance - prevDis > 30))  && cur_rgb.r + cur_rgb.g - cur_rgb.b <= 130 ){
                printf("ããã¾ã§é»è²ã¨ãªã¢ï¼ distance=%lf prevDis=%lf locX=%lf,locY=%lf,\n",distance,prevDis,locX,locY);
                stateMachine->sendTrigger(EVT_line_on_pid_cntl); //232
                g_challenge_stepNo = 250;

            //èµ¤ããä¸ã®é»ã©ã¤ã³ããã®é»ãè¦ã¤ããããã­ãã¯æ¹åã¸ã¿ã¼ã³ //hinu
            }else if(((root_no==3 && (g_challenge_stepNo == 220 || g_challenge_stepNo == 221 || g_challenge_stepNo == 195 ))|| ( root_no==2 && g_challenge_stepNo == 250)) && cur_rgb.g + cur_rgb.b <= 95 && cur_rgb.r <=50 && cur_rgb.g <=40 && cur_rgb.b <=60 && distance -prevDis > 170 ){   
                //accumuDegree = prevDegree360 - curDegree360 + 25;
                accumuDegree=-35;
                prevDegree360 = curDegree360;
                g_challenge_stepNo = 233;
                stateMachine->sendTrigger(EVT_line_on_pid_cntl); //233
                root_no=1;
                g_challenge_stepNo = 231;                

            //èµ¤ãè¦ã¤ãããé»ãè¦ã¤ããã¾ã§ç´é²ããã®å¾ã©ã¤ã³ãã¬ã¼ã¹
            }else if(g_challenge_stepNo == 220 && cur_rgb.r - cur_rgb.b >= 40 && cur_rgb.g < 60 && cur_rgb.r - cur_rgb.g > 30){
                g_challenge_stepNo = 240;
                //ç´åã¾ã§ã©ã¤ã³ãã¬ã¼ã¹
                stateMachine->sendTrigger(EVT_block_area_in); //240
                g_challenge_stepNo = 241;
            //èµ¤ãé¢è±ããããã«ä»¥ä¸ã®åå²ã«ããã«ã©ã¼ãé çªã«ãã©ã
            }else if( cur_rgb.r - cur_rgb.b < 20 && g_challenge_stepNo == 241){
                g_challenge_stepNo = 242;
            }else if( cur_rgb.r - cur_rgb.b >=40 && g_challenge_stepNo == 242){
                g_challenge_stepNo = 243;
            //èµ¤ãééæãå¤§ããã©ã¤ã³ãå¤ããããã«ã¼ããã¦æ»ã
            }else if(g_challenge_stepNo == 243 && cur_rgb.r + cur_rgb.g + cur_rgb.b > 300){
                g_challenge_stepNo = 244;
                stateMachine->sendTrigger(EVT_block_challenge); //244
                g_challenge_stepNo = 245;
                clock->sleep(10);
                stateMachine->sendTrigger(EVT_line_on_pid_cntl); //245
                g_challenge_stepNo = 220;
            //ã©ã¤ã³ãå¤ãã¦ããªããã°ãé»ã®ã©ã¤ã³ãã¬ã¼ã¹ã¸
            }else if(g_challenge_stepNo == 243 && cur_rgb.r + cur_rgb.g + cur_rgb.b <= 100){
                g_challenge_stepNo = 246;
                stateMachine->sendTrigger(EVT_line_on_pid_cntl); //246 
                g_challenge_stepNo = 220;
            }else if(g_challenge_stepNo==250){    
                //printf(",garage_flg=%d,slalom_flg=%d,distance=%lf,g_angle=%d,curDegree360=%d, curSonarDis=%d, g_challenge_stepNo=%d,r=%d,g=%d,b=%d,locX=%lf,locY=%lf\n",garage_flg,slalom_flg,distance,g_angle,curDegree360, curSonarDis,g_challenge_stepNo,cur_rgb.r,cur_rgb.g,cur_rgb.b,locX,locY);
                //ãã­ãã¯ã«ç´é²ããã­ãã¯ã®é»è²ãè¦ã¤ããã
                if(cur_rgb.r + cur_rgb.g - cur_rgb.b >= 150){
                        printf("ãã­ãã¯GETãã¦ã»ãã tempDis=%lf,locY=%lf,prevDisY=%lf,locX=%lf,prevDisX=%lf\n",tempDis,locY,prevDisY,locX,prevDisX);                 
                        g_challenge_stepNo = 260;
                        //prevDegree360=curDegree360;
                }
            }
        }

        //ãã¼ãã¹ãã­ãã¯å¾å
        else if (garage_flg && g_challenge_stepNo >= 260 && !slalom_flg){
             //if (g_challenge_stepNo >= 260 && g_challenge_stepNo <= 270){
            //     if (++traceCnt && traceCnt > 10) {
            //            printf(",garage_flg=%d,slalom_flg=%d,distance=%lf,g_angle=%d,curDegree360=%d, curSonarDis=%d, g_challenge_stepNo=%d,r=%d,g=%d,b=%d,locX=%lf,locY=%lf\n",garage_flg,slalom_flg,distance,g_angle,curDegree360, curSonarDis,g_challenge_stepNo,cur_rgb.r,cur_rgb.g,cur_rgb.b,locX,locY);
            //         traceCnt = 0;
            //     }
             //}

            //ã¬ã¬ã¼ã¸ã«æ»ãã¹ããã¿ã¼ã³        
            if(g_challenge_stepNo == 260){
                //èµ°è¡ä½åé ­
                stateMachine->sendTrigger(EVT_block_area_in); //260
                accumuDegree =  getTurnDgree(prevDegree360,curDegree360);
                printf("ï¼ï¼ï¼ãã¾ãã accumuDegree=%d,prevDegree360=%d,curDegree360=%d\n",accumuDegree,prevDegree360,curDegree360);
                prevDegree360 = curDegree360;
                prevDis=distance;
                g_challenge_stepNo = 264;   //hinu s

                //èµ¤ããã¤ã³ãããã®ãã­ãã¯å°éã®å ´å
                if(root_no==2){ 
                    //åè»¢è§åº¦ãã»ãã
                    //turnDegree = 290; //èµ¤ç´é²
                    //turnDegree = 149 + accumuDegree; //èµ¤ã«ã¼ã
                    turnDegree = 170;
                }else if(root_no==4){//é»è²éé

                    //turnDegree = 149 + accumuDegree;
                    turnDegree = 170;

                //é»ã©ã¤ã³ãé»è²ç´é²ããã®ãã­ãã¯å°éã®å ´å
                }else{
                    //åè»¢è§åº¦ã«80åº¦ãã»ãã
                    //turnDegree = 144 + accumuDegree;
                    turnDegree = 169;
                }
                
                accumuDegree = 0;

            }else if(g_challenge_stepNo == 264 && distance-prevDis > 150){ //hinu sããããã
                stateMachine->sendTrigger(EVT_block_challenge); //264
                g_challenge_stepNo = 261;
                printf("ï¼ï¼ï¼ãã¾ãã accumuDegree=%d\n",accumuDegree); //hinu s ããã¾ã§

            }else if(g_challenge_stepNo == 261 && accumuDegree > turnDegree){

                g_challenge_stepNo = 135;
                stateMachine->sendTrigger(EVT_block_challenge);
                clock->sleep(1000);
                g_challenge_stepNo = 261;
                stateMachine->sendTrigger(EVT_block_challenge); //261
                g_challenge_stepNo = 262;
                printf("ï¼ï¼ï¼ãã¾ãã accumuDegree=%dãturnDegree=%d\n",accumuDegree,turnDegree);


            }else if(g_challenge_stepNo == 261){ //è§åº¦ãæ¡ä»¶ã«è©²å½ããªãå ´åãå·®åãç´¯ç©ãã¦ããã
                accumuDegree += getTurnDgree(prevDegree360,curDegree360);
                prevDegree360 = curDegree360;
                //printf("ï¼ï¼ï¼ä¸­ accumuDegree=%dãturnDegree=%d\n",accumuDegree,turnDegree);
            //åæ¹ã«ä½ããªãç¶æ³ã«ãªã£ããé²è¡

            //}else if(g_challenge_stepNo == 262){
            }else if(g_challenge_stepNo == 262 && check_sonar(255,255) ){
//            }else if(g_challenge_stepNo == 262 && ((check_sonar(255,255) &&  accumuDegree > 175) || (accumuDegree > 185 && root_no==2) || (accumuDegree > 210 && root_no==1)) ){
                printf("èª¿æ´ä¸­ãåæ¹ã«ä½ããªãç¶æ³ã«ãªã£ããé²è¡ accumuDegree =%d curSonarDis=%d,curDegree360=%d\n",accumuDegree,curSonarDis,curDegree360);
                g_challenge_stepNo = 263;
                accumuDegree = 0;
                prevDegree360 = curDegree360;

            }else if(g_challenge_stepNo == 262){ //è§åº¦ãæ¡ä»¶ã«è©²å½ããªãå ´åãå·®åãç´¯ç©ãã¦ããã
                accumuDegree += getTurnDgree(prevDegree360,curDegree360);
                prevDegree360 = curDegree360;

            }else if(g_challenge_stepNo == 263){
                accumuDegree += getTurnDgree(prevDegree360,curDegree360);
                prevDegree360 = curDegree360;

                if(accumuDegree >= 17){ //255ãçºè¦ãã¦ããä½åº¦æ²ããããèª¿æ´
                    printf("è§åº¦èª¿æ´å¾ã«åé²ãã curSonarDis=%d,curDegree360=%d\n",curSonarDis,curDegree360);
                    stateMachine->sendTrigger(EVT_block_challenge); //263
                    g_challenge_stepNo = 270;
                    prevDis = distance;
                    prevDisX=locX;
                }
            }else if(g_challenge_stepNo == 270 && distance - prevDis > 380){
                //é»ç·ãã­ãã¯ãè¶ããã¾ã§ãä¸å®è·é¢ãèµ°è¡
                g_challenge_stepNo = 271;
            }else if(g_challenge_stepNo == 271 && check_sonar(255,255)){
                g_challenge_stepNo = 280;
            }else if(g_challenge_stepNo == 271 && check_sonar(1,254)){
                    //è¦çãéãã¦ãªããã°éåè»¢
                    stateMachine->sendTrigger(EVT_block_challenge);//271
                    prevDegree180=curDegree180;
                    printf("æ²ããåã¯è§åº¦ï¼=%d,curDegree360=%d,curSonarDis=%d\n",prevDegree180,curDegree360,curSonarDis);
                    g_challenge_stepNo = 272;
            }else if(g_challenge_stepNo == 272 && check_sonar(255,255)){
            //}else if(g_challenge_stepNo == 272 && (check_sonar(255,255)|| own_abs(prevDegree180 - curDegree180) > 30 )){
                    printf("æ²ãã£ãå¾ã¯è§åº¦ï¼=%d,curDegree360=%d,curSonarDis=%d\n",curDegree180,curDegree360,curSonarDis);
                    stateMachine->sendTrigger(EVT_block_challenge);//272
                    g_challenge_stepNo = 280;
            //ç·ãè¦ã¤ããããéåº¦åºå®                      
            }else if(g_challenge_stepNo == 280 && cur_rgb.r <= 13 && cur_rgb.b <= 50 && cur_rgb.g > 60){ 
                stateMachine->sendTrigger(EVT_block_challenge); //280
                g_challenge_stepNo = 281;
            //ä¸åº¦ç½ãéé
            }else if(g_challenge_stepNo == 281 && curRgbSum > 300){
                g_challenge_stepNo = 282;
            //ç·ãã¿ã¤ãããã«ã¼ãéå§
            }else if(g_challenge_stepNo == 282 && cur_rgb.r <= 13 && cur_rgb.b <= 50 && cur_rgb.g > 60 ){
                stateMachine->sendTrigger(EVT_block_challenge); //282
                g_challenge_stepNo = 283;
            //ä¸åº¦ç½ãéé
            }else if(g_challenge_stepNo == 283 && curRgbSum > 300){
                g_challenge_stepNo = 284;
            }else if(g_challenge_stepNo == 284 && cur_rgb.r + cur_rgb.g <= 150){  //éã¾ãã¯é»ãã¿ã¤ããããå®å¨ã«ã¿ã¼ã³)
                g_challenge_stepNo = 284;
                stateMachine->sendTrigger(EVT_block_challenge); //284
                g_challenge_stepNo = 285;
                clock->sleep(500);
            // ã¬ã¬ã¼ã¸ã®å¥¥ã®è·é¢ãæãããç´é²
            }else if(g_challenge_stepNo == 285 && check_sonar(35,250)){
                prevDegree360 = curDegree360;
                accumuDegree = 0;
                g_challenge_stepNo = 286;
            }else if(g_challenge_stepNo == 286){
                accumuDegree += getTurnDgree(prevDegree360,curDegree360);
                prevDegree360 = curDegree360;
                if(accumuDegree > 23){
                    stateMachine->sendTrigger(EVT_block_challenge); //286
                    g_challenge_stepNo = 290;
                }
            }else if(g_challenge_stepNo == 290 && check_sonar(0,16)){
                    stateMachine->sendTrigger(EVT_block_challenge); //290
                    garage_flg = false;
            }
        }//ã¬ã¬ã¼ã¸çµäº
    }

    /*
    int32_t iDeltaD  = (int32_t)(1000.0 * deltaDist );
    int32_t iDeltaDL = (int32_t)(1000.0 * deltaDistL);
    int32_t iDeltaDR = (int32_t)(1000.0 * deltaDistR);
    if (iDeltaDL != 0 && iDeltaDR != 0) {
        _debug(syslog(LOG_NOTICE, "%08u, %06d, %06d, %06d, %06d", clock->now(), getDistance(), iDeltaD, iDeltaDL, iDeltaDR));
    }
    */

    integD  += deltaDist;  // temp
    integDL += deltaDistL; // temp
    integDR += deltaDistR; // temp
    // display trace message in every PERIOD_TRACE_MSG ms
    if (++traceCnt * PERIOD_OBS_TSK >= PERIOD_TRACE_MSG) {
        traceCnt = 0;
        /*
        // temp from here
        int32_t iD  = (int32_t)integD;
        int32_t iDL = (int32_t)integDL;
        int32_t iDR = (int32_t)integDR;
        _debug(syslog(LOG_NOTICE, "%08u, %06d, %06d, %06d, %06d", clock->now(), getDistance(), iD, iDL, iDR));
        integD = integDL = integDR = 0.0;
        // temp to here
        */
        /*
        _debug(syslog(LOG_NOTICE, "%08u, Observer::operate(): distance = %d, azimuth = %d, x = %d, y = %d", clock->now(), getDistance(), getAzimuth(), getLocX(), getLocY()));
        _debug(syslog(LOG_NOTICE, "%08u, Observer::operate(): hsv = (%03u, %03u, %03u)", clock->now(), g_hsv.h, g_hsv.s, g_hsv.v));
        _debug(syslog(LOG_NOTICE, "%08u, Observer::operate(): rgb = (%03u, %03u, %03u)", clock->now(), g_rgb.r, g_rgb.g, g_rgb.b));
        _debug(syslog(LOG_NOTICE, "%08u, Observer::operate(): angle = %d, anglerVelocity = %d", clock->now(), g_angle, g_anglerVelocity));
        */
        //_debug(syslog(LOG_NOTICE, "%08u, Observer::operate(): sensor = %d, target = %d, distance = %d", clock->now(), g_grayScale, GS_TARGET, getDistance()));
    }
}

void Observer::deactivate() {
    // deregister cyclic handler from EV3RT
    stp_cyc(CYC_OBS_TSK);
    //clock->sleep() seems to be still taking milisec parm
    clock->sleep(PERIOD_OBS_TSK/2/1000); // wait a while
    _debug(syslog(LOG_NOTICE, "%08u, Observer handler unset", clock->now()));
}

bool Observer::check_touch(void) {
    if (touchSensor->isPressed()) {
        return true;
    } else {
        return false;
    }
}

bool Observer::check_sonar(void) {
    int32_t distance = sonarSensor->getDistance();
    if ((distance <= SONAR_ALERT_DISTANCE) && (distance >= 0)) {
        return true; // obstacle detected - alert
    } else {
        return false; // no problem
    }
}

bool Observer::check_sonar(int16_t sonar_alert_dist_from, int16_t sonar_alert_dist_to) {
    int32_t distance = sonarSensor->getDistance();
    //printf(",distance2=%d, sonar_alert_dist_from=%d, sonar_alert_dist_to=%d\n",distance, sonar_alert_dist_from, sonar_alert_dist_to );
    if (distance >= sonar_alert_dist_from && distance <= sonar_alert_dist_to) {
        return true; // obstacle detected - alert
    } else {
        return false; // no problem
    }
}

bool Observer::check_backButton(void) {
    if (ev3_button_is_pressed(BACK_BUTTON)) {
        return true;
    } else {
        return false;
    }
}

bool Observer::check_lost(void) {
    if (g_grayScale > GS_LOST) {
        return true;
    } else {
        return false;
    }
    /*
    int8_t otRes_r, otRes_g, otRes_b;
    otRes_r = ot_r->test(cur_rgb.r);
    otRes_g = ot_g->test(cur_rgb.g);
    otRes_b = ot_b->test(cur_rgb.b);
    if ((otRes_r == POS_OUTLIER && otRes_g == POS_OUTLIER) ||
        (otRes_g == POS_OUTLIER && otRes_b == POS_OUTLIER) ||
        (otRes_b == POS_OUTLIER && otRes_r == POS_OUTLIER)) {
        return true;
    } else {
        return false;
    }
    */
}

// bool Observer::check_tilt(void) {
//     int16_t anglerVelocity = gyroSensor->getAnglerVelocity();
//     if (anglerVelocity < ANG_V_TILT && anglerVelocity > (-1) * ANG_V_TILT) {
//         return false;
//     } else {
//         _debug(syslog(LOG_NOTICE, "%08u, Observer::operate(): TILT anglerVelocity = %d", clock->now(), anglerVelocity));
//         return true;
//     }
// }

void Observer::freeze() {
    frozen = true;
}

void Observer::unfreeze() {
    frozen = false;
}

//è§åº¦ç´¯ç©åãè¨ç®
int16_t Observer::getTurnDgree(int16_t prev_x,int16_t x){

    int16_t hoge = prev_x-x;
    if(hoge < 0){
        hoge = hoge * -1;
    }
    if(hoge > 180){
        hoge = 360-hoge;
    }

    return hoge;    
}

Observer::~Observer() {
    _debug(syslog(LOG_NOTICE, "%08u, Observer destructor", clock->now()));
}